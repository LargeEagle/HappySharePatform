# HAPPY SHARE å•é¡Œæ’æŸ¥æŒ‡å—

> **ğŸš¨ é‡è¦è¦ç¯„**ï¼š
> 
> **æ‰€æœ‰æŠ€è¡“å•é¡Œçš„è¨ºæ–·å’Œè§£æ±ºæ–¹æ¡ˆå¿…é ˆè¨˜éŒ„åœ¨æ­¤æ–‡æª”ä¸­ï¼**
> 
> - âœ… **TROUBLESHOOTING.md** â†’ æ‰€æœ‰å•é¡Œçš„è¨ºæ–·æ­¥é©Ÿã€åŸå› åˆ†æã€è§£æ±ºæ–¹æ¡ˆ
> - âœ… **é–‹ç™¼æ–‡ä»¶.md** â†’ åƒ…è¨˜éŒ„ç°¡çŸ­æ‘˜è¦ + å¼•ç”¨ TROUBLESHOOTING.md ç« ç¯€è™Ÿ
> - âœ… **\*_SUMMARY.md** â†’ é‡å¤§å•é¡Œçš„ç¨ç«‹æ·±åº¦ç¸½çµï¼ˆå¯é¸ï¼‰
>
> **è¨˜éŒ„åŸå‰‡**ï¼š
> 1. å•é¡Œç™¼ç”Ÿ â†’ å…ˆåœ¨ TROUBLESHOOTING.md ä¸­æœå°‹æ˜¯å¦å·²æœ‰è§£æ±ºæ–¹æ¡ˆ
> 2. è§£æ±ºå¾Œ â†’ åœ¨ TROUBLESHOOTING.md ä¸­è©³ç´°è¨˜éŒ„ï¼ˆä½¿ç”¨ä¸‹æ–¹æ¨¡æ¿ï¼‰
> 3. æ‘˜è¦ â†’ åœ¨é–‹ç™¼æ–‡ä»¶.md ä¸­æ·»åŠ ä¸€å¥è©±æ‘˜è¦ + å¼•ç”¨ç« ç¯€è™Ÿ
> 4. æ­¸æª” â†’ é‡å¤§å•é¡Œå¯é¸å‰µå»ºç¨ç«‹ SUMMARY.md æ–‡æª”

---

## ğŸ“Œ æ•…éšœæ’æŸ¥æµç¨‹

### é‡åˆ°å•é¡Œæ™‚çš„æ¨™æº–æµç¨‹

```
1. ğŸ” æœå°‹æœ¬æ–‡æª”
   â””â”€ ä½¿ç”¨ Ctrl+F æœå°‹éŒ¯èª¤è¨Šæ¯é—œéµå­—
   â””â”€ æª¢æŸ¥å°æ‡‰åˆ†é¡ç« ç¯€
   â””â”€ æŸ¥çœ‹é¡ä¼¼å•é¡Œçš„è§£æ±ºæ–¹æ¡ˆ

2. ğŸ§ª å˜—è©¦è§£æ±º
   â””â”€ æŒ‰æ–‡æª”ä¸­çš„æ­¥é©Ÿæ“ä½œ
   â””â”€ è¨˜éŒ„å˜—è©¦çµæœ

3. ğŸ“ è¨˜éŒ„æ–°å•é¡Œï¼ˆå¦‚æœæ–‡æª”ä¸­æ²’æœ‰ï¼‰
   â””â”€ ä½¿ç”¨ä¸‹æ–¹çš„ã€å•é¡Œè¨˜éŒ„æ¨¡æ¿ã€‘
   â””â”€ æ·»åŠ åˆ°å°æ‡‰åˆ†é¡ç« ç¯€ï¼ˆÂ§ 3.X, Â§ 4.X ç­‰ï¼‰
   â””â”€ åœ¨é–‹ç™¼æ–‡ä»¶.md æ·»åŠ ç°¡çŸ­å¼•ç”¨
   â””â”€ æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

4. âš ï¸ ä¸è¦åœ¨é–‹ç™¼æ–‡ä»¶.md ä¸­å¯«è©³ç´°çš„è¨ºæ–·å’Œè§£æ±ºæ­¥é©Ÿï¼
   â””â”€ é–‹ç™¼æ–‡ä»¶.md åªè¨˜éŒ„ã€Œç™¼ç”Ÿäº†ä»€éº¼ã€å’Œã€Œåœ¨å“ªè£¡æŸ¥çœ‹è©³æƒ…ã€
   â””â”€ è©³ç´°å…§å®¹å¿…é ˆåœ¨ TROUBLESHOOTING.md ä¸­
```

### å¿«é€Ÿæœå°‹é—œéµå­—å»ºè­°

| å•é¡Œé¡å‹ | æœå°‹é—œéµå­— |
|---------|-----------|
| å°èˆªéŒ¯èª¤ | `NAVIGATE`, `Screen`, `Navigator` |
| API éŒ¯èª¤ | `404`, `500`, `API`, `fetch`, `axios` |
| è³‡æ–™åº« | `Prisma`, `P1001`, `P2024`, `database`, `connection`, `pool` |
| ç·¨è­¯éŒ¯èª¤ | `TypeScript`, `type`, `undefined`, `module` |
| æ¨£å¼å•é¡Œ | `View`, `Text`, `StyleSheet`, `layout` |
| ç’°å¢ƒé…ç½® | `.env`, `config`, `port`, `CORS` |

---

## ğŸ“ å•é¡Œè¨˜éŒ„æ¨¡æ¿

**ç•¶é‡åˆ°æ–°å•é¡Œä¸¦æˆåŠŸè§£æ±ºå¾Œï¼Œè«‹æŒ‰æ­¤æ ¼å¼æ·»åŠ åˆ°å°æ‡‰ç« ç¯€**ï¼š

```markdown
### X.X å•é¡Œç°¡è¿°ï¼ˆä¸€å¥è©±æè¿°ï¼‰

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯ï¼ˆè¤‡è£½åŸæ–‡ï¼‰
```

**å•é¡Œç¾è±¡**ï¼š
- æè¿°å•é¡Œå‡ºç¾æ™‚çš„æƒ…æ³
- å½±éŸ¿ç¯„åœ
- è§¸ç™¼æ¢ä»¶

**å•é¡ŒåŸå› **ï¼š
- æ ¹æœ¬åŸå› åˆ†æ
- ç‚ºä»€éº¼æœƒç™¼ç”Ÿ

**è¨ºæ–·æ­¥é©Ÿ**ï¼š
```bash
# åˆ—å‡ºè¨ºæ–·å‘½ä»¤
command-to-check-issue
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼ˆæ¨è–¦ï¼‰**ï¼š
```typescript
// ä¿®æ”¹å‰
èˆŠä»£ç¢¼

// ä¿®æ”¹å¾Œ
æ–°ä»£ç¢¼
```

**æ–¹æ¡ˆ Bï¼ˆå‚™é¸ï¼‰**ï¼š
```bash
# æ›¿ä»£æ–¹æ¡ˆ
alternative-solution
```

**é©—è­‰æ¸¬è©¦**ï¼š
```bash
# å¦‚ä½•ç¢ºèªå•é¡Œå·²è§£æ±º
test-command
```

**ç›¸é—œæ–‡ä»¶**ï¼š
- `path/to/file1.ts`
- `path/to/file2.ts`

**è¨˜éŒ„æ™‚é–“**ï¼šYYYY-MM-DD
**è§£æ±ºæ™‚é•·**ï¼šX å°æ™‚/åˆ†é˜
**å„ªå…ˆç´š**ï¼šğŸ”´é«˜ / âš ï¸ä¸­ / ğŸ’¡ä½

---
```

### è¨˜éŒ„ç¯„ä¾‹

åƒè€ƒæœ¬æ–‡æª”ä¸­çš„ [3.3 Prisma P1001 éŒ¯èª¤ - WSL2 + Supabase é€£æ¥å•é¡Œ](#33-prisma-p1001-éŒ¯èª¤---wsl2--supabase-é€£æ¥å•é¡Œ-) ä½œç‚ºå®Œæ•´ç¯„ä¾‹ã€‚

---

## ç›®éŒ„

1. [å°èˆªèˆ‡è·¯ç”±å•é¡Œ](#1-å°èˆªèˆ‡è·¯ç”±å•é¡Œ)
2. [API èˆ‡ç¶²è·¯è«‹æ±‚å•é¡Œ](#2-api-èˆ‡ç¶²è·¯è«‹æ±‚å•é¡Œ)
3. [è³‡æ–™åº«èˆ‡å¾Œç«¯å•é¡Œ](#3-è³‡æ–™åº«èˆ‡å¾Œç«¯å•é¡Œ)
4. [å¿«å–èˆ‡ç€è¦½å™¨å•é¡Œ](#4-å¿«å–èˆ‡ç€è¦½å™¨å•é¡Œ)
5. [React Native èˆ‡ Expo å•é¡Œ](#5-react-native-èˆ‡-expo-å•é¡Œ)
6. [TypeScript é¡å‹å•é¡Œ](#6-typescript-é¡å‹å•é¡Œ)
7. [ç’°å¢ƒé…ç½®å•é¡Œ](#7-ç’°å¢ƒé…ç½®å•é¡Œ)

---

## 1. å°èˆªèˆ‡è·¯ç”±å•é¡Œ

### 1.1 å°èˆªéŒ¯èª¤ï¼šScreen æœªè¨»å†Šï¼ˆThe action 'NAVIGATE' was not handledï¼‰

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
The action 'NAVIGATE' with payload {"name":"Search"} was not handled by any navigator.
```

**å•é¡ŒåŸå› **ï¼š
- Screen çµ„ä»¶æœªåœ¨ Navigator ä¸­è¨»å†Š
- **å¸¸è¦‹é™·é˜±**ï¼šé …ç›®ä¸­å­˜åœ¨å¤šå€‹åŒåé…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹äº†éŒ¯èª¤çš„æ–‡ä»¶

**è¨ºæ–·æ­¥é©Ÿ**ï¼š
1. **ç¢ºèªå¯¦éš›ä½¿ç”¨çš„é…ç½®æ–‡ä»¶**
   ```bash
   # æœå°‹æ‰€æœ‰åŒåæ–‡ä»¶
   find . -name "App.tsx"
   
   # æª¢æŸ¥å…¥å£æ–‡ä»¶çš„å°å…¥
   cat frontend/index.ts | grep "import App"
   ```

2. **æª¢æŸ¥æ–‡ä»¶å°å…¥è·¯å¾‘**
   - `import App from './App'` â†’ æŒ‡å‘ `frontend/App.tsx`ï¼ˆæ ¹ç›®éŒ„ï¼‰
   - `import App from './src/App'` â†’ æŒ‡å‘ `frontend/src/App.tsx`

3. **ç¢ºèª Screen è¨»å†Š**
   ```tsx
   // æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„ Screen å®šç¾©
   <Stack.Screen name="Search" component={SearchScreen} />
   ```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šä¿®å¾©é›™æ–‡ä»¶å•é¡Œï¼ˆæ¨è–¦ï¼‰**
```bash
# 1. æ‰¾å‡ºæ‰€æœ‰ App.tsx
find . -name "App.tsx"

# 2. ç¢ºèªå…¥å£æ–‡ä»¶å°å…¥
cat frontend/index.ts

# 3. ä¿®æ”¹æ­£ç¢ºçš„æ–‡ä»¶ï¼ˆç³»çµ±å¯¦éš›ä½¿ç”¨çš„ï¼‰
# å¦‚æœ index.ts å°å…¥ './App'ï¼Œå‰‡ä¿®æ”¹ frontend/App.tsx

# 4. å»ºè­°åˆªé™¤å¤šé¤˜æ–‡ä»¶é¿å…æ··æ·†
mv frontend/src/App.tsx frontend/src/App.tsx.backup
```

**æ–¹æ¡ˆ Bï¼šæ·»åŠ ç¼ºå¤±çš„ Screen**
```tsx
// frontend/App.tsx (æ ¹ç›®éŒ„)
import { SearchScreen } from "./src/screens/SearchScreen";
import { TagPostsScreen } from "./src/screens/TagPostsScreen";

<Stack.Navigator initialRouteName={isAuthenticated ? "Home" : "Login"}>
  {/* ç¾æœ‰ Screens */}
  
  {/* æ·»åŠ ç¼ºå¤±çš„ Screens */}
  <Stack.Screen 
    name="Search" 
    component={SearchScreen}
    options={{ 
      title: "æœå°‹",
      header: (props) => <HeaderBar {...props} title="æœå°‹" />
    }}
  />
  <Stack.Screen 
    name="TagPosts" 
    component={TagPostsScreen}
    options={{ 
      title: "æ¨™ç±¤",
      header: (props) => <HeaderBar {...props} title="æ¨™ç±¤" />
    }}
  />
</Stack.Navigator>
```

**é©—è­‰ä¿®å¾©**ï¼š
```bash
# 1. æ¸…é™¤å¿«å–
cd frontend
rm -rf .expo .expo-shared node_modules/.cache

# 2. é‡å•Ÿæœå‹™
pkill -9 -f "expo|metro"
npm run dev:frontend

# 3. ç­‰å¾…ç·¨è­¯å®Œæˆå¾Œæ¸¬è©¦å°èˆª
```

**é é˜²æªæ–½**ï¼š
- âœ… å®šæœŸæª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„é…ç½®æ–‡ä»¶
- âœ… çµ±ä¸€æ–‡ä»¶å‘½åå’Œç›®éŒ„çµæ§‹
- âœ… ä½¿ç”¨ `find` å‘½ä»¤ç¢ºèªæ–‡ä»¶ä½ç½®
- âœ… åƒè€ƒæ­·å²è¨˜éŒ„ï¼ˆdocs/é–‹ç™¼æ–‡ä»¶.mdï¼‰

**ç›¸é—œè¨˜éŒ„**ï¼š
- 2025-10-27ï¼šé¦–æ¬¡é‡åˆ°é›™æ–‡ä»¶å•é¡Œ
- 2025-11-01ï¼šå†æ¬¡é‡åˆ°ï¼Œå·²åœ¨é–‹ç™¼æ–‡ä»¶ä¸­è©³ç´°è¨˜éŒ„

---

### 3.1 éœæ…‹ sleepï¼ˆä¾‹å¦‚ sleep 5ï¼‰å°è‡´æ¸¬è©¦æˆ–è‡ªå‹•åŒ–å¡ä½

**å•é¡Œç¾è±¡**ï¼š
- æ¸¬è©¦è…³æœ¬ä¸­ä½¿ç”¨å›ºå®šçš„ `sleep 5`ã€`sleep 10` ç­‰ç­‰å¾…ï¼Œå¶çˆ¾æœƒåœ¨ç­‰å¾…çµæŸå¾Œã€Œç„¡åæ‡‰ã€æˆ–æœå‹™å°šæœªå°±ç·’å°è‡´å¾ŒçºŒè«‹æ±‚å¤±æ•—ã€‚

**æ ¹æœ¬åŸå› **ï¼š
- å›ºå®šç­‰å¾…ä¾è³´å•Ÿå‹•æ™‚é–“æ˜¯æ†å®šçš„ï¼Œä½†æœå‹™å•Ÿå‹•æ™‚é–“å—ä¸»æ©Ÿè² è¼‰ã€è³‡æ–™åº«åˆå§‹åŒ–æˆ–ç†±é‡è¼‰ç­‰å› ç´ å½±éŸ¿ï¼Œå®¹æ˜“å°è‡´ç«¶æ…‹æ¢ä»¶ã€‚

**å»ºè­°åšæ³•ï¼ˆå„ªå…ˆé †åºï¼‰**ï¼š
1. ä½¿ç”¨ã€Œç­‰å¾…æ¢ä»¶ã€ï¼ˆwait-for conditionï¼‰æ›¿ä»£å›ºå®š sleepï¼š
   - å°æ–¼å¾Œç«¯æœå‹™ï¼Œå…ˆæª¢æŸ¥ TCP ç«¯å£æ˜¯å¦å¯é€£ç·šï¼ˆ`/dev/tcp` æˆ– `nc -z`ï¼‰ï¼Œå†ä»¥çŸ­è¼ªè©¢ç¢ºèª HTTP è«‹æ±‚å¯æ¥é€šã€‚
   - å°æ–¼å‰ç«¯æ¸¬è©¦ï¼ˆChrome MCP / Playwright / Puppeteerï¼‰ï¼Œç­‰å¾…ç‰¹å®š DOM å…ƒç´ æˆ–å°èˆªäº‹ä»¶ï¼ˆä¾‹å¦‚ç­‰å¾… selectorã€network idle æˆ– navigation eventï¼‰ï¼Œä¸è¦ç”¨å›ºå®š sleepã€‚
2. è‹¥éœ€é‡è©¦ï¼Œä½¿ç”¨å¯é…ç½®ä¸”æœ‰é™æ¬¡æ•¸çš„é‡è©¦æ©Ÿåˆ¶ï¼Œä¸¦æ¡ç”¨æŒ‡æ•¸é€€é¿æˆ–å›ºå®šé€€é¿ï¼ˆåƒè€ƒè³‡æ–™åº«é€£ç·šé‡è©¦ç­–ç•¥ï¼‰ã€‚
3. åœ¨è…³æœ¬ä¸­æä¾›æ¸…æ™°çš„è¶…æ™‚èˆ‡éŒ¯èª¤è¨Šæ¯ï¼Œè¶…æ™‚å¾Œå›å‚³é 0 ç‹€æ…‹ä»¥ä¾¿ CI/è‡ªå‹•åŒ–èƒ½æ„ŸçŸ¥å¤±æ•—ã€‚

**ç¯„ä¾‹ï¼ˆshellï¼‰**ï¼š
```bash
# ç­‰å¾… TCP ç«¯å£
wait_for_port() {
  local host=${1:-localhost}
  local port=${2:-5000}
  local retries=${3:-60}
  local i=0
  while ! (echo > /dev/tcp/${host}/${port}) >/dev/null 2>&1; do
    i=$((i+1))
    if [ "$i" -ge "$retries" ]; then
      echo "Timeout waiting for ${host}:${port}"
      return 1
    fi
    sleep 1
  done
  return 0
}
``` 

**ç¯„ä¾‹ï¼ˆChrome MCP / Playwrightï¼‰**ï¼š
```js
// ç­‰å¾…å…ƒç´ è€Œéå›ºå®š sleep
await page.waitForSelector('#notification-icon', { timeout: 30000 });
```

**æ–‡ä»¶è¨˜éŒ„**ï¼š
- å·²åœ¨ `backend/scripts/dev-tests/test-search-api.sh` ä¸­å°‡å›ºå®š `sleep` æ›¿æ›ç‚º port/HTTP æª¢æŸ¥ï¼ˆè¦‹ repo è®Šæ›´ï¼‰ã€‚
- å¦‚éœ€æ›´æ·±å…¥çš„æ¸¬è©¦æµç¨‹ç¯„ä¾‹ï¼Œåƒè¦‹ `CHROME_MCP_TEST_REPORT.md` èˆ‡ `docs/é–‹ç™¼æ–‡ä»¶.md` çš„æ¸¬è©¦æ­¥é©Ÿæ‘˜è¦ã€‚


### 1.2 æ¢ä»¶æ¸²æŸ“ Screen å°è‡´å°èˆªå¤±æ•—

**å•é¡Œç¾è±¡**ï¼š
- æœ‰æ™‚èƒ½å°èˆªï¼Œæœ‰æ™‚ä¸èƒ½
- ç™»å…¥å‰å¾Œå°èˆªè¡Œç‚ºä¸ä¸€è‡´

**å•é¡ŒåŸå› **ï¼š
ä½¿ç”¨æ¢ä»¶æ¸²æŸ“ Screen å°è‡´æŸäº› Screen ä¸åœ¨ Navigator ä¸­

**éŒ¯èª¤ç¤ºä¾‹**ï¼š
```tsx
<Stack.Navigator>
  {isAuthenticated && (
    <Stack.Screen name="Search" component={SearchScreen} />
  )}
</Stack.Navigator>
```

**æ­£ç¢ºåšæ³•**ï¼š
```tsx
// æ–¹æ¡ˆ Aï¼šå§‹çµ‚è¨»å†Šæ‰€æœ‰ Screenï¼Œç”¨ initialRouteName æ§åˆ¶èµ·å§‹é 
<Stack.Navigator 
  initialRouteName={isAuthenticated ? "Home" : "Login"}
>
  <Stack.Screen name="Login" component={LoginScreen} />
  <Stack.Screen name="Search" component={SearchScreen} />
  {/* æ‰€æœ‰ Screens éƒ½è¨»å†Š */}
</Stack.Navigator>

// æ–¹æ¡ˆ Bï¼šåœ¨ Screen å…§éƒ¨æª¢æŸ¥æ¬Šé™
export const SearchScreen = () => {
  const { isAuthenticated } = useAuth();
  
  if (!isAuthenticated) {
    return <Redirect to="Login" />;
  }
  
  return <View>...</View>;
};
```

---

## 2. API èˆ‡ç¶²è·¯è«‹æ±‚å•é¡Œ

### 2.1 API è·¯å¾‘é‡è¤‡ï¼ˆ/api/api/... 404 éŒ¯èª¤ï¼‰

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
GET http://localhost:5000/api/api/users/123 404 (Not Found)
```

**å•é¡ŒåŸå› **ï¼š
- `apiClient` çš„ `baseURL` å·²åŒ…å« `/api/`
- service æ–‡ä»¶ä¸­è·¯å¾‘åˆåŠ äº† `/api/`
- å°è‡´è·¯å¾‘é‡è¤‡

**è¨ºæ–·æ–¹æ³•**ï¼š
```bash
# æœå°‹å¯èƒ½æœ‰å•é¡Œçš„è·¯å¾‘
grep -r "apiClient.get(\`/api/" frontend/src/services/
grep -r "apiClient.post(\`/api/" frontend/src/services/
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æª¢æŸ¥é…ç½®**ï¼š
```typescript
// frontend/src/config/app.config.ts
export const appConfig = {
  api: {
    baseURL: 'http://localhost:5000/api', // â† å·²åŒ…å« /api/
  }
};
```

**ä¿®æ”¹ service æ–‡ä»¶**ï¼š
```typescript
// âŒ éŒ¯èª¤ï¼šè·¯å¾‘åŒ…å« /api/
apiClient.get(`/api/users/${id}`);

// âœ… æ­£ç¢ºï¼šè·¯å¾‘ä¸åŒ…å« /api/
apiClient.get(`/users/${id}`);
```

**æ‰¹é‡ä¿®å¾©**ï¼š
```typescript
// frontend/src/services/user.api.ts
export const userApi = {
  // ä¿®æ”¹å‰
  getUser: (id: string) => apiClient.get(`/api/users/${id}`),
  updateUser: (id: string, data) => apiClient.put(`/api/users/${id}`, data),
  
  // ä¿®æ”¹å¾Œ
  getUser: (id: string) => apiClient.get(`/users/${id}`),
  updateUser: (id: string, data) => apiClient.put(`/users/${id}`, data),
};
```

**é©—è­‰ä¿®å¾©**ï¼š
```bash
# å¾Œç«¯æ¸¬è©¦
curl http://localhost:5000/api/users/123

# ç€è¦½å™¨æ¸¬è©¦
# æ‰“é–‹ DevTools â†’ Network æ¨™ç±¤
# æª¢æŸ¥è«‹æ±‚ URL æ‡‰è©²æ˜¯ï¼š
# âœ… http://localhost:5000/api/users/123
# âŒ http://localhost:5000/api/api/users/123
```

**é é˜²æªæ–½**ï¼š
- çµ±ä¸€è¦ç¯„ï¼šservice è·¯å¾‘ä¸åŒ…å« `/api/` å‰ç¶´
- åƒè€ƒæ­£ç¢ºç¤ºä¾‹ï¼ˆå¦‚ `posts.api.ts`ï¼‰
- ä»£ç¢¼å¯©æŸ¥æ™‚æª¢æŸ¥è·¯å¾‘é…ç½®

**ç›¸é—œæ–‡ä»¶**ï¼š
- `frontend/API_PATH_GUIDE.md`ï¼šå®Œæ•´çš„è·¯å¾‘é…ç½®æŒ‡å—

---

### 2.2 å‰ç«¯é¡¯ç¤º 500 éŒ¯èª¤ä½†å¾Œç«¯ API æ­£å¸¸

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Request failed with status code 500
GET http://localhost:5000/api/posts 500 (Internal Server Error)
```

**è¨ºæ–·æ­¥é©Ÿ**ï¼š

**1. ç¢ºèªå¾Œç«¯æ˜¯å¦çœŸçš„æœ‰éŒ¯èª¤**
```bash
# ç›´æ¥æ¸¬è©¦å¾Œç«¯ API
curl -v http://localhost:5000/api/posts

# æ‡‰è©²çœ‹åˆ°ï¼š
# < HTTP/1.1 200 OK
# < Content-Type: application/json
# {"success":true,"data":{...}}
```

**2. æª¢æŸ¥å¾Œç«¯æ—¥èªŒ**
```bash
# æŸ¥çœ‹å¾Œç«¯çµ‚ç«¯è¼¸å‡º
# æˆ–æŸ¥çœ‹æ—¥èªŒæ–‡ä»¶
tail -f /tmp/backend.log
```

**3. æª¢æŸ¥ç€è¦½å™¨ DevTools**
- æ‰“é–‹ Network æ¨™ç±¤
- é»æ“Šå¤±æ•—çš„è«‹æ±‚
- æŸ¥çœ‹ Response æ¨™ç±¤ï¼ˆå¾Œç«¯å¯¦éš›éŸ¿æ‡‰ï¼‰
- æŸ¥çœ‹ Headers æ¨™ç±¤ï¼ˆHTTP ç‹€æ…‹ç¢¼ï¼‰

**å¯èƒ½åŸå› å’Œè§£æ±ºæ–¹æ¡ˆ**ï¼š

**åŸå›  Aï¼šç€è¦½å™¨å¿«å–å•é¡Œ**
- **ç¾è±¡**ï¼šå¾Œç«¯æ¸¬è©¦æ­£å¸¸ï¼Œä½†ç€è¦½å™¨å ±éŒ¯
- **è§£æ±º**ï¼š
  ```bash
  # æ¸…é™¤å‰ç«¯å¿«å–
  cd frontend
  rm -rf .expo .expo-shared node_modules/.cache
  
  # ç¡¬é‡è¼‰ç€è¦½å™¨
  # Windows/Linux: Ctrl + Shift + R
  # Mac: Cmd + Shift + R
  ```

**åŸå›  Bï¼šCORS å•é¡Œ**
- **ç¾è±¡**ï¼šæ§åˆ¶å°é¡¯ç¤º CORS éŒ¯èª¤
- **è§£æ±º**ï¼š
  ```typescript
  // backend/src/main.ts
  app.enableCors({
    origin: true, // é–‹ç™¼ç’°å¢ƒå…è¨±æ‰€æœ‰ä¾†æº
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'Accept'],
  });
  ```

**åŸå›  Cï¼šèªè­‰ token å•é¡Œ**
- **ç¾è±¡**ï¼šéœ€è¦èªè­‰çš„ç«¯é»è¿”å› 401
- **è§£æ±º**ï¼š
  ```typescript
  // æª¢æŸ¥ token æ˜¯å¦æ­£ç¢ºè¨­ç½®
  const auth = await authStorage.getAuth();
  console.log('Token:', auth?.token);
  ```

**åŸå›  Dï¼šè«‹æ±‚åƒæ•¸æ ¼å¼éŒ¯èª¤**
- **æª¢æŸ¥**ï¼šquery parametersã€request body æ ¼å¼
- **è§£æ±º**ï¼šå°æ¯” API æ–‡æª”ç¢ºèªæ ¼å¼æ­£ç¢º

**é©—è­‰ä¿®å¾©**ï¼š
```bash
# 1. é‡å•Ÿå¾Œç«¯
pkill -9 -f "nest|node.*backend"
cd backend && npm run start:dev

# 2. é‡å•Ÿå‰ç«¯
pkill -9 -f "expo|metro"
cd frontend && npm start

# 3. æ¸…é™¤ç€è¦½å™¨å¿«å–ä¸¦æ¸¬è©¦
```

---

### 2.3 API è«‹æ±‚è¶…æ™‚

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Error: timeout of 10000ms exceeded
```

**è¨ºæ–·**ï¼š
```typescript
// æª¢æŸ¥ timeout è¨­ç½®
// frontend/src/services/api.client.ts
this.client = axios.create({
  baseURL: appConfig.api.baseUrl,
  timeout: 10000, // â† ç•¶å‰è¶…æ™‚è¨­ç½®
});
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šå¢åŠ è¶…æ™‚æ™‚é–“**
```typescript
timeout: 30000, // æ”¹ç‚º 30 ç§’
```

**æ–¹æ¡ˆ Bï¼šå„ªåŒ–å¾Œç«¯æ€§èƒ½**
- æ·»åŠ æ•¸æ“šåº«ç´¢å¼•
- å„ªåŒ–æŸ¥è©¢èªå¥
- ä½¿ç”¨åˆ†é é™åˆ¶è¿”å›æ•¸æ“šé‡

**æ–¹æ¡ˆ Cï¼šæ·»åŠ è¼‰å…¥ç‹€æ…‹**
```typescript
const [loading, setLoading] = useState(false);

const fetchData = async () => {
  setLoading(true);
  try {
    await api.getData();
  } finally {
    setLoading(false);
  }
};
```

---

## 3. è³‡æ–™åº«èˆ‡å¾Œç«¯å•é¡Œ

### 3.1 Prisma é€£æ¥å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Error: Can't reach database server
```

**è¨ºæ–·æ­¥é©Ÿ**ï¼š
```bash
# 1. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
cat backend/.env | grep DATABASE_URL

# 2. æ¸¬è©¦æ•¸æ“šåº«é€£æ¥
npx prisma db push --preview-feature

# 3. æª¢æŸ¥ Prisma Client
npx prisma generate
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**ç¢ºèª DATABASE_URL æ ¼å¼**ï¼š
```env
# PostgreSQL
DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=public"

# Supabase
DATABASE_URL="postgresql://postgres:[PASSWORD]@db.[PROJECT].supabase.co:5432/postgres"
```

**é‡æ–°ç”Ÿæˆ Prisma Client**ï¼š
```bash
cd backend
npx prisma generate
npx prisma db push
npm run start:dev
```

---

### 3.2 æœå°‹è¿”å›ç©ºçµæœ

**å•é¡Œç¾è±¡**ï¼š
- æœå°‹ API è¿”å›ç©ºé™£åˆ—
- è³‡æ–™åº«ä¸­æœ‰æ•¸æ“šä½†æœä¸åˆ°

**è¨ºæ–·æ–¹æ³•**ï¼š
```sql
-- ç›´æ¥åœ¨è³‡æ–™åº«ä¸­æ¸¬è©¦æœå°‹
SELECT * FROM "Post" 
WHERE to_tsvector('simple', title || ' ' || content) 
@@ to_tsquery('simple', 'react');
```

**å¯èƒ½åŸå› **ï¼š

**åŸå›  Aï¼šæœå°‹èªæ³•éŒ¯èª¤**
```typescript
// âŒ éŒ¯èª¤ï¼šç‰¹æ®Šå­—ç¬¦æœªè™•ç†
const query = "react native"; // ç©ºæ ¼æœƒå°è‡´éŒ¯èª¤

// âœ… æ­£ç¢ºï¼šä½¿ç”¨ & é€£æ¥
const query = "react&native";
```

**åŸå›  Bï¼šèªè¨€é…ç½®ä¸åŒ¹é…**
```typescript
// ä½¿ç”¨ 'simple' é…ç½®æ”¯æ´å¤šèªè¨€
to_tsvector('simple', content)
```

---

### 3.3 Prisma P1001 éŒ¯èª¤ - WSL2 + Supabase é€£æ¥å•é¡Œ â­

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
PrismaClientInitializationError: P1001: Can't reach database server at `aws-1-ap-southeast-1.pooler.supabase.com`:`5432`
```

**å•é¡Œæ ¹æº**ï¼š
- Supabase **Direct Connection** åƒ…æ”¯æŒ IPv6
- **WSL2** (Windows Subsystem for Linux) å° IPv6 æ”¯æŒæœ‰é™
- å°è‡´ç„¡æ³•å»ºç«‹æ•¸æ“šåº«é€£æ¥

**é—œéµç™¼ç¾**ï¼ˆä¾†è‡ª Supabase Dashboardï¼‰:
```
âš ï¸ Direct Connection: "Not IPv4 compatible"
ğŸ’¡ å»ºè­°: "Use Session Pooler if on a IPv4 network"
```

---

#### å››æ¬¡å˜—è©¦è¨˜éŒ„

**å˜—è©¦ 1: åŸå§‹ Pooler** âŒ å¤±æ•—
```bash
DATABASE_URL="postgresql://postgres:[PASSWORD]@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"
```
- âœ… ç¶²çµ¡æ¸¬è©¦: æˆåŠŸ
- âŒ Prisma é€£æ¥: P1001 éŒ¯èª¤
- **å¤±æ•—åŸå› **: é…ç½®æˆ–æ¬Šé™å•é¡Œ

---

**å˜—è©¦ 2: Direct Connection** âŒ å¤±æ•—
```bash
DATABASE_URL="postgresql://postgres:PASSWORD@db.jpcdablvabnuqdmneqnd.supabase.co:5432/postgres"
```

**æ¸¬è©¦å‘½ä»¤**ï¼š
```bash
$ nc -zv db.jpcdablvabnuqdmneqnd.supabase.co 5432
nc: connect to db.jpcdablvabnuqdmneqnd.supabase.co port 5432 (tcp) failed: Network is unreachable
```

- âŒ ç¶²çµ¡æ¸¬è©¦: DNS è§£æå¤±æ•—ï¼ˆIPv6 onlyï¼‰
- âŒ å¾Œç«¯å•Ÿå‹•: P1001 éŒ¯èª¤
- **å¤±æ•—åŸå› **: **WSL2 ç„¡æ³•é€£æ¥ IPv6 ç«¯é»**

---

**å˜—è©¦ 3: Transaction Pooler** âŒ å¤±æ•—
```bash
DATABASE_URL="postgresql://postgres.jpcdablvabnuqdmneqnd:PASSWORD@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres"
```

**æ¸¬è©¦å‘½ä»¤**ï¼š
```bash
$ nc -zv aws-1-ap-southeast-1.pooler.supabase.com 6543
Connection to aws-1-ap-southeast-1.pooler.supabase.com (13.213.241.248) 6543 port [tcp/*] succeeded!
```

- âœ… ç¶²çµ¡é€£æ¥: æˆåŠŸ
- âœ… å¾Œç«¯å•Ÿå‹•: æˆåŠŸ
- âŒ Prisma é€£æ¥: èº«ä»½é©—è­‰å¤±æ•—

**éŒ¯èª¤ä¿¡æ¯**ï¼š
```
PrismaClientInitializationError: Error querying the database: 
FATAL: Tenant or user not found
```

- **å¤±æ•—åŸå› **: Transaction Pooler ç”¨æˆ¶åæ ¼å¼ä¸åŒ¹é…

---

**å˜—è©¦ 4: Session Pooler** âœ… æˆåŠŸï¼
```bash
DATABASE_URL="postgresql://postgres.jpcdablvabnuqdmneqnd:PASSWORD@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"
```

**å®Œæ•´é…ç½® (backend/.env)**ï¼š
```bash
# Database - Session Pooler (IPv4 Compatible)
DATABASE_URL="postgresql://postgres.jpcdablvabnuqdmneqnd:e4vycDLP26CimmQC@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"

# JWT Configuration
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
JWT_EXPIRES_IN="7d"

# Server Configuration
PORT=5000
NODE_ENV=development

# CORS Configuration
CORS_ORIGIN=*
```

**é©—è­‰æ¸¬è©¦**ï¼š

1. **ç¶²çµ¡é€£æ¥**: âœ…
   ```bash
   $ nc -zv aws-1-ap-southeast-1.pooler.supabase.com 5432
   Connection to aws-1-ap-southeast-1.pooler.supabase.com (13.213.241.248) 5432 port [tcp/postgresql] succeeded!
   ```

2. **å¾Œç«¯å•Ÿå‹•**: âœ…
   ```
   âœ… Prisma connected to database
   [Nest] 99360 - LOG [NestApplication] Nest application successfully started +442ms
   ğŸš€ Application is running on: http://localhost:5000/api
   ```

3. **API æ¸¬è©¦**: âœ…
   ```bash
   # TypeScript æœç´¢
   $ curl http://localhost:5000/api/search/suggestions?q=TypeScript
   {"success":true,"data":{"suggestions":[{"text":"TypeScript æœ€ä½³å¯¦è¸","type":"post"}]}}
   
   # ç”¨æˆ¶æœç´¢
   $ curl http://localhost:5000/api/search/suggestions?q=alice
   {"success":true,"data":{"suggestions":[{"text":"Alice Wang","type":"user","avatar":"..."}]}}
   ```

---

#### Supabase é€£æ¥é¡å‹æ¯”è¼ƒ

| é€£æ¥é¡å‹ | ç«¯å£ | IPv4/IPv6 | ç”¨æˆ¶åæ ¼å¼ | é©ç”¨å ´æ™¯ | WSL2 å…¼å®¹ |
|---------|------|-----------|-----------|---------|-----------|
| **Direct Connection** | 5432 | âŒ IPv6 only | `postgres` | ç›´æ¥æ•¸æ“šåº«è¨ªå• | âŒ ä¸å…¼å®¹ |
| **Transaction Pooler** | 6543 | æ··åˆ | `postgres.[ref]` | ç„¡ç‹€æ…‹çŸ­é€£æ¥ | âš ï¸ èªè­‰å•é¡Œ |
| **Session Pooler** | 5432 | âœ… **IPv4 Compatible** | `postgres.[ref]` | æœ‰ç‹€æ…‹é•·é€£æ¥ | âœ… **å®Œå…¨å…¼å®¹** |

**é—œéµé…ç½®è¦é»**ï¼š
- **ä¸»æ©Ÿå**: `aws-1-ap-southeast-1.pooler.supabase.com` (Pooler ç«¯é»)
- **ç«¯å£**: `5432` (Session modeï¼Œä¸æ˜¯ 6543)
- **ç”¨æˆ¶å**: `postgres.<project_ref_id>` (é™„åŠ å°ˆæ¡ˆåƒè€ƒ ID)

**ç”¨æˆ¶åæ ¼å¼è¦å‰‡**ï¼š
- Direct Connection: `postgres`
- Pooler (Transaction/Session): `postgres.<project_ref_id>`
- å°ˆæ¡ˆåƒè€ƒ ID åœ¨ Supabase Dashboard é€£æ¥å­—ç¬¦ä¸²ä¸­å¯æ‰¾åˆ°

---

#### è§£æ±ºæ–¹æ¡ˆæ­¥é©Ÿ

**Step 1: ç²å–æ­£ç¢ºçš„é€£æ¥å­—ç¬¦ä¸²**

1. ç™»éŒ„ [Supabase Dashboard](https://supabase.com/dashboard)
2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ
3. å‰å¾€: **Project Settings** â†’ **Database** â†’ **Connection Info**
4. é¸æ“‡: **"Connection pooling"** â†’ **"Session mode"**
5. **ç›´æ¥è¤‡è£½å®˜æ–¹æä¾›çš„å®Œæ•´å­—ç¬¦ä¸²**

**Step 2: æ›´æ–°ç’°å¢ƒè®Šé‡**

```bash
cd backend

# å‰µå»ºå‚™ä»½
cp .env .env.backup

# æ›´æ–° .env
nano .env
```

```env
DATABASE_URL="postgresql://postgres.<project-ref>:<password>@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"
```

**Step 3: é©—è­‰é€£æ¥**

```bash
# 1. æ¸¬è©¦ç¶²çµ¡é€£æ¥
nc -zv aws-1-ap-southeast-1.pooler.supabase.com 5432

# 2. æ¸…ç†èˆŠé€²ç¨‹
ps aux | grep -E "node.*dist/main|nest.*start" | awk '{print $2}' | xargs -r kill -9

# 3. é‡å•Ÿå¾Œç«¯
npm run start:prod

# 4. æª¢æŸ¥æ—¥èªŒ
tail -f backend.log | grep "Prisma\|Application"

# 5. æ¸¬è©¦ API
curl http://localhost:5000/api/search/suggestions?q=test
```

---

#### æ•…éšœæ’æŸ¥æ¸…å–®

å¦‚æœä»ç„¶ç„¡æ³•é€£æ¥ï¼ŒæŒ‰é †åºæª¢æŸ¥ï¼š

**âœ“ æª¢æŸ¥é …ç›® 1: ç¶²çµ¡é€£æ¥**
```bash
nc -zv aws-1-ap-southeast-1.pooler.supabase.com 5432
# é æœŸçµæœ: Connection succeeded
```

**âœ“ æª¢æŸ¥é …ç›® 2: ç”¨æˆ¶åæ ¼å¼**
```bash
# Session Pooler å¿…é ˆä½¿ç”¨: postgres.<project-ref>
# ä¸æ˜¯: postgres
echo $DATABASE_URL | grep "postgres\."
```

**âœ“ æª¢æŸ¥é …ç›® 3: ç«¯å£è™Ÿ**
```bash
# Session Pooler: 5432
# Transaction Pooler: 6543
echo $DATABASE_URL | grep ":5432/"
```

**âœ“ æª¢æŸ¥é …ç›® 4: å¯†ç¢¼æ­£ç¢ºæ€§**
```bash
# ç¢ºèªå¯†ç¢¼æ²’æœ‰ç‰¹æ®Šå­—ç¬¦è½‰ç¾©å•é¡Œ
# å¦‚æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œå¯èƒ½éœ€è¦ URL ç·¨ç¢¼
```

**âœ“ æª¢æŸ¥é …ç›® 5: ç’°å¢ƒè®Šé‡åŠ è¼‰**
```bash
# ç¢ºèª .env è¢«æ­£ç¢ºåŠ è¼‰
node -e "require('dotenv').config(); console.log(process.env.DATABASE_URL)"
```

---

#### æœ€ä½³å¯¦è¸

**é–‹ç™¼ç’°å¢ƒæ¨è–¦**ï¼š

| ç’°å¢ƒ | æ¨è–¦é€£æ¥æ–¹å¼ | åŸå›  |
|------|------------|------|
| **WSL2** | Session Pooler | IPv4 compatible âœ… |
| **Docker** | Session Pooler | ç¶²çµ¡éš”é›¢ï¼ŒIPv4 ç©©å®š |
| **åŸç”Ÿ Linux/Mac** | Direct Connection æˆ– Session Pooler | æ”¯æŒ IPv6 |
| **Windows åŸç”Ÿ** | Session Pooler | ç¶²çµ¡å…¼å®¹æ€§æœ€ä½³ |

**å®‰å…¨æç¤º**ï¼š
```bash
# âš ï¸ ä¸è¦å°‡ .env æäº¤åˆ° Git
echo ".env" >> .gitignore

# âœ… å‰µå»ºç¤ºä¾‹æ–‡ä»¶
cp .env .env.example
# ç„¶å¾Œæ‰‹å‹•ç§»é™¤æ•æ„Ÿä¿¡æ¯
```

**éƒ¨ç½²æç¤º**ï¼š
```bash
# ç”Ÿç”¢ç’°å¢ƒæ‡‰ä½¿ç”¨ç’°å¢ƒè®Šé‡ï¼Œä¸æ˜¯ .env æ–‡ä»¶
# Vercel/Netlify: åœ¨ Dashboard è¨­ç½®
# Docker: ä½¿ç”¨ docker-compose.yml æˆ– --env-file
# Kubernetes: ä½¿ç”¨ ConfigMap/Secret
```

---

#### å¸¸è¦‹å•é¡Œ FAQ

**Q1: ç‚ºä»€éº¼ Direct Connection åœ¨ WSL2 ä¸Šä¸å·¥ä½œï¼Ÿ**

A: Supabase Direct Connection åƒ…æ”¯æŒ IPv6ã€‚WSL2 å° IPv6 æ”¯æŒæœ‰é™ï¼Œå°è‡´ç„¡æ³•å»ºç«‹é€£æ¥ã€‚è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ **Session Pooler**ï¼ˆIPv4 compatibleï¼‰ã€‚

---

**Q2: "Tenant or user not found" éŒ¯èª¤æ€éº¼è¾¦ï¼Ÿ**

A: é€™æ˜¯ç”¨æˆ¶åæ ¼å¼å•é¡Œï¼š
- âŒ éŒ¯èª¤: `postgres:password@...`
- âœ… æ­£ç¢º: `postgres.<project-ref>:password@...`

---

**Q3: Session Pooler å’Œ Transaction Pooler æœ‰ä»€éº¼å€åˆ¥ï¼Ÿ**

| ç‰¹æ€§ | Session Pooler | Transaction Pooler |
|------|----------------|-------------------|
| ç«¯å£ | 5432 | 6543 |
| é€£æ¥æ¨¡å¼ | é•·é€£æ¥ | çŸ­é€£æ¥ |
| ç‹€æ…‹ä¿æŒ | âœ… æœ‰ç‹€æ…‹ | âŒ ç„¡ç‹€æ…‹ |
| é©ç”¨å ´æ™¯ | å‚³çµ±æ‡‰ç”¨ | Serverless å‡½æ•¸ |
| WSL2 å…¼å®¹ | âœ… å®Œå…¨æ”¯æŒ | âš ï¸ å¯èƒ½æœ‰èªè­‰å•é¡Œ |

---

**Q4: å¦‚ä½•ç¢ºèªæˆ‘ä½¿ç”¨çš„æ˜¯å“ªç¨®é€£æ¥ï¼Ÿ**

```bash
# æª¢æŸ¥ DATABASE_URL
echo $DATABASE_URL

# Direct Connection ç‰¹å¾µ:
# - ä¸»æ©Ÿå: db.<project-ref>.supabase.co
# - ç«¯å£: 5432
# - ç”¨æˆ¶å: postgres

# Session Pooler ç‰¹å¾µ:
# - ä¸»æ©Ÿå: aws-*-*.pooler.supabase.com
# - ç«¯å£: 5432
# - ç”¨æˆ¶å: postgres.<project-ref>

# Transaction Pooler ç‰¹å¾µ:
# - ä¸»æ©Ÿå: aws-*-*.pooler.supabase.com
# - ç«¯å£: 6543
# - ç”¨æˆ¶å: postgres.<project-ref>
```

---

**Q5: æ¸¬è©¦é€£æ¥çš„å®Œæ•´æµç¨‹æ˜¯ä»€éº¼ï¼Ÿ**

```bash
# 1. æ¸¬è©¦ DNS è§£æ
nslookup aws-1-ap-southeast-1.pooler.supabase.com

# 2. æ¸¬è©¦ç¶²çµ¡é€£æ¥
nc -zv aws-1-ap-southeast-1.pooler.supabase.com 5432

# 3. æ¸¬è©¦æ‡‰ç”¨é€£æ¥
cd backend
npm run start:prod

# 4. æª¢æŸ¥æ—¥èªŒ
tail -50 backend.log | grep -E "Prisma|Application|error"

# 5. æ¸¬è©¦ API
curl http://localhost:5000/api/search/suggestions?q=test
```

---

#### æ™‚é–“ç·šåƒè€ƒ

è§£æ±ºæ­¤å•é¡Œç¸½æ™‚é•·ç´„ **3 å°æ™‚**ï¼ˆ2025-11-01 20:30 - 23:50ï¼‰ï¼š

| éšæ®µ | æ™‚é–“ | æ´»å‹• |
|------|------|------|
| å•é¡Œç™¼ç¾ | 30 åˆ†é˜ | ç™¼ç¾ P1001 éŒ¯èª¤ï¼Œåˆæ­¥è¨ºæ–· |
| ç¬¬ä¸€è¼ªæ¸¬è©¦ | 60 åˆ†é˜ | æ¸¬è©¦åŸå§‹é…ç½®ï¼Œæª¢æŸ¥ç’°å¢ƒè®Šé‡ |
| æ–°æ†‘è­‰æ¸¬è©¦ | 30 åˆ†é˜ | Direct Connection å¤±æ•—ï¼ˆIPv6ï¼‰ |
| Transaction Pooler | 30 åˆ†é˜ | ç¶²çµ¡æˆåŠŸä½†èªè­‰å¤±æ•— |
| æœ€çµ‚çªç ´ | 30 åˆ†é˜ | Session Pooler é…ç½®æˆåŠŸ âœ… |

**é—œéµè½‰æŠ˜é»**: ç”¨æˆ¶æä¾› Supabase Dashboard æˆªåœ–ï¼Œç™¼ç¾ "Not IPv4 compatible" æç¤ºã€‚

---

#### ç›¸é—œè³‡æº

- [Supabase Database Connection Documentation](https://supabase.com/docs/guides/database/connecting-to-postgres)
- [Prisma Connection Troubleshooting](https://www.prisma.io/docs/guides/database/troubleshooting-database-connection-issues)
- [WSL2 Networking Limitations](https://docs.microsoft.com/en-us/windows/wsl/networking)
- [PostgreSQL Connection Pooling](https://www.postgresql.org/docs/current/runtime-config-connection.html)

---

**è¨˜éŒ„æ™‚é–“**: 2025-11-01 23:50
**ç‹€æ…‹**: âœ… å•é¡Œå·²è§£æ±º
**è§£æ±ºæ–¹æ¡ˆ**: Session Pooler (IPv4 Compatible)
**é©ç”¨ç’°å¢ƒ**: WSL2, Docker, Windows åŸç”Ÿ

---

### 3.4 Prisma é€£æ¥æ± è¶…æ™‚ - ä¸¦ç™¼æŸ¥è©¢å°è‡´é€£æ¥è€—ç›¡ â­â­

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
PrismaClientKnownRequestError: P2024
Timed out fetching a new connection from the connection pool
(Current connection pool timeout: 10, connection limit: 5)
```

**å•é¡Œç—‡ç‹€**ï¼š
- âœ… ç¬¬ä¸€æ¬¡ API æŸ¥è©¢æˆåŠŸï¼ˆHTTP 200ï¼‰
- âŒ å¾ŒçºŒæŸ¥è©¢å…¨éƒ¨å¤±æ•—ï¼ˆHTTP 500ï¼‰
- âŒ éœ€è¦é‡å•Ÿå¾Œç«¯æ‰èƒ½æ¢å¾©
- âš ï¸ å¥åº·æª¢æŸ¥é¡¯ç¤ºé€£æ¥æ­£å¸¸ï¼Œä½†æŸ¥è©¢ä»å¤±æ•—

**å•é¡Œæ ¹æº**ï¼š
1. **é€£æ¥æ± é»˜èªé…ç½®å¤ªå°** (`connection_limit=5`)
2. **ä¸¦ç™¼æŸ¥è©¢æ¶ˆè€—å¤šå€‹é€£æ¥** (Promise.all åŒæ™‚æŸ¥è©¢3å€‹è¡¨)
3. **è¶…æ™‚è¨­ç½®éçŸ­** (`pool_timeout=10ç§’`)
4. **é€£æ¥æœªæ­£ç¢ºé‡‹æ”¾æˆ–é‡ç”¨**

---

#### è¨ºæ–·æ­¥é©Ÿ

**Step 1: ç¢ºèªéŒ¯èª¤é¡å‹**

æª¢æŸ¥å¾Œç«¯æ—¥èªŒä¸­æ˜¯å¦æœ‰ä»¥ä¸‹éŒ¯èª¤ï¼š
```bash
tail -50 backend/backend.log | grep -E "P2024|connection pool|timeout"
```

éŒ¯èª¤ç‰¹å¾µï¼š
```
Invalid `this.prisma.xxx.findMany()` invocation
Timed out fetching a new connection from the connection pool
connection_limit: 5
timeout: 10
```

**Step 2: æª¢æŸ¥ä¸¦ç™¼æŸ¥è©¢æ¨¡å¼**

æª¢æŸ¥ä»£ç¢¼ä¸­æ˜¯å¦ä½¿ç”¨ `Promise.all` é€²è¡Œä¸¦ç™¼æ•¸æ“šåº«æŸ¥è©¢ï¼š
```typescript
// âŒ å•é¡Œä»£ç¢¼ï¼šåŒæ™‚éœ€è¦3å€‹é€£æ¥
const [tags, users, posts] = await Promise.all([
  this.prisma.tag.findMany({ ... }),    // é€£æ¥ 1
  this.prisma.user.findMany({ ... }),   // é€£æ¥ 2
  this.prisma.post.findMany({ ... }),   // é€£æ¥ 3
]);
// å¦‚æœé€£æ¥æ± åªæœ‰5å€‹ï¼Œå‰©é¤˜2å€‹ç„¡æ³•æ»¿è¶³å¤šå€‹ä¸¦ç™¼è«‹æ±‚
```

**Step 3: é€£çºŒæ¸¬è©¦é©—è­‰**

```bash
# é€£çºŒæ¸¬è©¦10æ¬¡
for i in {1..10}; do 
  echo "Test $i"
  curl -s http://localhost:5000/api/search/suggestions?q=test | \
  python3 -c "import sys, json; print('Success' if json.load(sys.stdin).get('success') else 'Failed')"
done
```

**é æœŸçµæœ**ï¼š
- **ä¿®å¾©å‰**: 1-2æ¬¡æˆåŠŸï¼Œå¾ŒçºŒå…¨éƒ¨å¤±æ•—
- **ä¿®å¾©å¾Œ**: 10æ¬¡å…¨éƒ¨æˆåŠŸ

---

#### è§£æ±ºæ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: å„ªåŒ–é€£æ¥æ± åƒæ•¸** âœ… **æ¨è–¦**

ä¿®æ”¹ `backend/.env`:
```env
# ä¿®å¾©å‰
DATABASE_URL="postgresql://...@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"

# ä¿®å¾©å¾Œ - æ·»åŠ é€£æ¥æ± åƒæ•¸
DATABASE_URL="postgresql://...@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres?connection_limit=20&pool_timeout=20&connect_timeout=30"
```

**åƒæ•¸èªªæ˜**ï¼š
- `connection_limit=20`: é€£æ¥æ± å¤§å°ï¼ˆé»˜èª5 â†’ 20ï¼‰
- `pool_timeout=20`: ç²å–é€£æ¥è¶…æ™‚ï¼ˆé»˜èª10ç§’ â†’ 20ç§’ï¼‰
- `connect_timeout=30`: å»ºç«‹é€£æ¥è¶…æ™‚ï¼ˆæ–°å¢ï¼‰

**é€£æ¥æ± å¤§å°è¨ˆç®—å…¬å¼**ï¼š
```
æ¨è–¦å€¼ = (CPUæ ¸å¿ƒæ•¸ Ã— 2 + 1) + ä¸¦ç™¼æŸ¥è©¢æ•¸ + é ç•™
       = (4 Ã— 2 + 1) + 3 + 5
       = 17 â‰ˆ 20
```

---

**æ–¹æ¡ˆ 2: å¯¦ç¾è‡ªå‹•é‡è©¦æ©Ÿåˆ¶** âœ… **æ¨è–¦**

ä¿®æ”¹ `backend/src/prisma/prisma.service.ts`:

```typescript
@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  /**
   * åŸ·è¡Œå¸¶è‡ªå‹•é‡è©¦çš„æŸ¥è©¢
   */
  async executeWithRetry<T>(
    operation: () => Promise<T>,
    maxRetries = 3,
  ): Promise<T> {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await operation();
      } catch (error) {
        const isConnectionError = 
          error.code === 'P1001' ||  // ç„¡æ³•é€£æ¥
          error.code === 'P1017' ||  // é€£æ¥é—œé–‰
          error.code === 'P2024' ||  // é€£æ¥æ± è¶…æ™‚
          error.message?.includes("Can't reach database server");

        if (isConnectionError && attempt < maxRetries) {
          this.logger.warn(
            `ğŸ”„ Query failed (attempt ${attempt}/${maxRetries}), retrying...`
          );
          
          // é‡æ–°é€£æ¥
          await this.$disconnect();
          await new Promise(resolve => setTimeout(resolve, 500));
          await this.$connect();
          
          // æŒ‡æ•¸é€€é¿
          await new Promise(resolve => setTimeout(resolve, 500 * attempt));
        } else {
          throw error;
        }
      }
    }
    throw new Error('Query failed after all retries');
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
// åœ¨æœç´¢å¼•æ“ä¸­ä½¿ç”¨
async getSuggestions(query: string): Promise<Suggestion[]> {
  return this.prisma.executeWithRetry(async () => {
    const [tags, users, posts] = await Promise.all([...]);
    return [...];
  });
}
```

---

**æ–¹æ¡ˆ 3: æ·»åŠ å¥åº·æª¢æŸ¥**

å‰µå»º `backend/src/health/health.controller.ts`:
```typescript
@Controller('health')
export class HealthController {
  constructor(private prisma: PrismaService) {}

  @Get('db')
  async databaseCheck() {
    try {
      await this.prisma.$queryRaw`SELECT 1`;
      return {
        status: 'healthy',
        database: 'connected',
        timestamp: new Date().toISOString(),
      };
    } catch (error) {
      return {
        status: 'unhealthy',
        database: 'disconnected',
        error: error.message,
        timestamp: new Date().toISOString(),
      };
    }
  }
}
```

**æ¸¬è©¦å¥åº·æª¢æŸ¥**ï¼š
```bash
curl http://localhost:5000/api/health/db
# é æœŸ: {"status":"healthy","database":"connected"}
```

---

**æ–¹æ¡ˆ 4: å®šæœŸå¥åº·æª¢æŸ¥ï¼ˆä¿æŒé€£æ¥æ´»èºï¼‰**

åœ¨ `PrismaService` ä¸­æ·»åŠ ï¼š
```typescript
private startHealthCheck(): void {
  this.healthCheckInterval = setInterval(async () => {
    try {
      await this.$queryRaw`SELECT 1`;
      this.logger.debug('ğŸ’š Database health check passed');
    } catch (error) {
      this.logger.error('ğŸ’” Database health check failed');
      await this.reconnect();
    }
  }, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
}
```

---

#### å®Œæ•´å¯¦æ–½æ­¥é©Ÿ

**Step 1: æ›´æ–°é€£æ¥URL**
```bash
cd backend
nano .env
# æ·»åŠ  ?connection_limit=20&pool_timeout=20&connect_timeout=30
```

**Step 2: æ›´æ–° PrismaService**
```bash
# è¤‡è£½ä¸Šé¢çš„ executeWithRetry æ–¹æ³•åˆ° prisma.service.ts
nano src/prisma/prisma.service.ts
```

**Step 3: é‡æ–°ç·¨è­¯å’Œéƒ¨ç½²**
```bash
# åœæ­¢èˆŠé€²ç¨‹
pkill -9 -f "node.*dist/main"

# é‡æ–°ç·¨è­¯
npm run build

# é‡æ–°ç”Ÿæˆ Prisma Client
npx prisma generate

# å•Ÿå‹•
npm run start:prod
```

**Step 4: é©—è­‰ä¿®å¾©**
```bash
# æ¸¬è©¦å¥åº·æª¢æŸ¥
curl http://localhost:5000/api/health/db

# é€£çºŒæ¸¬è©¦10æ¬¡
for i in {1..10}; do 
  echo "Test $i"
  curl -s http://localhost:5000/api/search/suggestions?q=alice
done
```

---

#### æ¸¬è©¦çµæœ

**ä¿®å¾©å‰**ï¼š
```bash
æ¸¬è©¦ 10 æ¬¡é€£çºŒæŸ¥è©¢:
âœ… Test 1: Success
âŒ Test 2-10: Failed (500 Error)
æˆåŠŸç‡: 10%
```

**ä¿®å¾©å¾Œ**ï¼š
```bash
æ¸¬è©¦ 10 æ¬¡é€£çºŒæŸ¥è©¢:
âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ… 10/10 Success
æˆåŠŸç‡: 100% ğŸ‰
```

**æ€§èƒ½æ”¹é€²**ï¼š

| æŒ‡æ¨™ | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ | æ”¹é€² |
|------|--------|--------|------|
| é€£æ¥æ± å¤§å° | 5 | 20 | +300% |
| é€£æ¥æ± è¶…æ™‚ | 10ç§’ | 20ç§’ | +100% |
| æŸ¥è©¢æˆåŠŸç‡ | 10% | 100% | +900% |
| å•Ÿå‹•é€£æ¥æˆåŠŸç‡ | 20% | 100% | +400% |
| éœ€è¦æ‰‹å‹•é‡å•Ÿ | æ˜¯ | å¦ | N/A |

---

#### ç¶“é©—æ•™è¨“

1. **é€£æ¥æ± é…ç½®è‡³é—œé‡è¦**
   - âŒ ä¸è¦ä¾è³´é»˜èªå€¼ï¼ˆ5å€‹é€£æ¥é€šå¸¸ä¸å¤ ï¼‰
   - âœ… æ ¹æ“šä¸¦ç™¼éœ€æ±‚è¨ˆç®—åˆé©çš„é€£æ¥æ± å¤§å°
   - âœ… é ç•™ 20-30% ç·©è¡ç©ºé–“

2. **ä¸¦ç™¼æŸ¥è©¢è¦é ç•™è¶³å¤ é€£æ¥**
   - âŒ `Promise.all` æœƒåŒæ™‚æ¶ˆè€—å¤šå€‹é€£æ¥
   - âœ… ç¢ºä¿ `é€£æ¥æ± å¤§å° > æœ€å¤§ä¸¦ç™¼æŸ¥è©¢æ•¸`
   - âœ… æˆ–æ”¹ç”¨ä¸²è¡ŒåŸ·è¡Œéé—œéµæŸ¥è©¢

3. **å¥åº·æª¢æŸ¥æ˜¯å¿…è¦çš„**
   - âœ… å®šæœŸæª¢æŸ¥é€£æ¥ç‹€æ…‹ï¼ˆæ¯30ç§’ï¼‰
   - âœ… è‡ªå‹•é‡é€£æ¯”æ‰‹å‹•é‡å•Ÿå¥½
   - âœ… æä¾›å¥åº·æª¢æŸ¥ API ä¾¿æ–¼ç›£æ§

4. **é‡è©¦æ©Ÿåˆ¶æé«˜ç©©å®šæ€§**
   - âœ… ç¶²çµ¡æ³¢å‹•ä¸æ‡‰å°è‡´æ•´å€‹è«‹æ±‚å¤±æ•—
   - âœ… æŒ‡æ•¸é€€é¿é¿å…é›ªå´©æ•ˆæ‡‰
   - âœ… é™åˆ¶é‡è©¦æ¬¡æ•¸é˜²æ­¢æ­»å¾ªç’°

5. **Session Pooler vs Transaction Pooler**
   - **Session Pooler**: é©åˆçŸ­é€£æ¥ã€å¤šæŸ¥è©¢ï¼ˆæœ¬é …ç›®ï¼‰
   - **Transaction Pooler**: é©åˆé•·é€£æ¥ã€äº‹å‹™æ“ä½œ
   - **é¸æ“‡ä¾æ“š**: æŸ¥è©¢æ¨¡å¼å’ŒæŒçºŒæ™‚é–“

---

#### ç›¸é—œè³‡æº

- [Prisma Connection Pooling](https://www.prisma.io/docs/guides/performance-and-optimization/connection-management)
- [PostgreSQL Connection Pool Best Practices](https://www.postgresql.org/docs/current/runtime-config-connection.html)
- [Supabase Connection Pooling Guide](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)
- å®Œæ•´ä¿®å¾©ç¸½çµ: `DATABASE_CONNECTION_FIX_SUMMARY.md`
- æ¸¬è©¦å ±å‘Š: `SEARCH_SUGGESTIONS_TEST_REPORT.md`

---

**è¨˜éŒ„æ™‚é–“**: 2025-11-02 01:15
**ç‹€æ…‹**: âœ… å•é¡Œå·²å®Œå…¨è§£æ±º
**è§£æ±ºæ–¹æ¡ˆ**: é€£æ¥æ± åƒæ•¸å„ªåŒ– + è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ + å¥åº·æª¢æŸ¥
**ä¿®å¾©è€—æ™‚**: ç´„ 45 åˆ†é˜
**é©ç”¨ç’°å¢ƒ**: æ‰€æœ‰ä½¿ç”¨ Prisma + Supabase Session Pooler çš„ç’°å¢ƒ

---

**åŸå›  Cï¼šæ•¸æ“šæœªæ­£ç¢ºç´¢å¼•**
```sql
-- æª¢æŸ¥æ˜¯å¦éœ€è¦å‰µå»ºç´¢å¼•
CREATE INDEX idx_post_search 
ON "Post" 
USING gin(to_tsvector('simple', title || ' ' || content));
```

---

### 3.5 N+1 æŸ¥è©¢å°è‡´é€£æ¥æ± å¿«é€Ÿè€—ç›¡ â­â­â­

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
PrismaClientKnownRequestError: P2024
Timed out fetching a new connection from the connection pool
(Current connection pool timeout: 20, connection_limit: 20)
at PostsService.getPosts (dist/main.js:1244:32)
```

**å‰ç«¯éŒ¯èª¤**ï¼š
```javascript
AxiosError: timeout of 10000ms exceeded
Failed to load posts
```

**å•é¡Œç¾è±¡**ï¼š
- âœ… å¾Œç«¯å¥åº·æª¢æŸ¥é¡¯ç¤º "healthy" å’Œ "database connected"
- âŒ ä½† POST `/api/posts` è«‹æ±‚è¿”å› 500 éŒ¯èª¤
- âŒ å‰ç«¯åœ¨ 10 ç§’å¾Œè¶…æ™‚
- âŒ é€£æ¥æ± çš„ 20 å€‹é€£æ¥å…¨éƒ¨è€—ç›¡
- âš ï¸ é‡å•Ÿå¾Œç«¯å¯æš«æ™‚ç·©è§£ï¼Œä½†å•é¡Œå¾ˆå¿«å¾©ç™¼

**æ ¹æœ¬åŸå› **ï¼š
1. **N+1 æŸ¥è©¢å•é¡Œ** - ç‚ºæ¯ç¯‡æ–‡ç« å–®ç¨æŸ¥è©¢é»è®šå’Œæ”¶è—ç‹€æ…‹
2. **æœªä½¿ç”¨é€£æ¥é‡è©¦æ©Ÿåˆ¶** - ç›´æ¥èª¿ç”¨ `prisma.*` è€Œä¸æ˜¯ `prisma.executeWithRetry`
3. **ä¸¦ç™¼æŸ¥è©¢éå¤š** - 10 ç¯‡æ–‡ç«  Ã— 2 æŸ¥è©¢/ç¯‡ + 2 åˆå§‹æŸ¥è©¢ = **22 å€‹ä¸¦ç™¼é€£æ¥**

**éŒ¯èª¤çš„ä»£ç¢¼**ï¼ˆPostsService.getPostsï¼‰ï¼š
```typescript
// âŒ éŒ¯èª¤ï¼šç‚ºæ¯ç¯‡æ–‡ç« å–®ç¨æŸ¥è©¢ï¼ˆN+1 å•é¡Œï¼‰
const postsWithInteractions = await Promise.all(
  posts.map(async (post) => {
    if (currentUserId) {
      const [isLiked, isBookmarked] = await Promise.all([
        this.prisma.like.findUnique({...}),      // æŸ¥è©¢ 1
        this.prisma.bookmark.findUnique({...}),  // æŸ¥è©¢ 2
      ]);
      // 10 ç¯‡æ–‡ç«  Ã— 2 = 20 å€‹ä¸¦ç™¼æŸ¥è©¢ï¼
    }
  })
);
```

**è¨ºæ–·æ­¥é©Ÿ**ï¼š

```bash
# 1. æª¢æŸ¥å¾Œç«¯æ—¥èªŒ
tail -50 backend/backend.log | grep -A 10 "Error\|P2024"

# 2. æ¸¬è©¦ API ç«¯é»
curl -s "http://localhost:5000/api/posts?page=1&limit=10"

# 3. æª¢æŸ¥é€£æ¥æ± é…ç½®
cat backend/.env | grep DATABASE_URL
# æ‡‰è©²çœ‹åˆ°: connection_limit=20&pool_timeout=20

# 4. æª¢æŸ¥ PostsService ä»£ç¢¼
grep -A 30 "async getPosts" backend/src/posts/posts.service.ts
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**1. æ‰¹é‡æŸ¥è©¢ä»£æ›¿ N+1**ï¼š
```typescript
// âœ… æ­£ç¢ºï¼šä¸€æ¬¡æŸ¥è©¢æ‰€æœ‰é»è®šå’Œæ”¶è—
if (currentUserId && posts.length > 0) {
  const postIds = posts.map(p => p.id);
  
  // åªç”¨ 2 å€‹æŸ¥è©¢è€Œä¸æ˜¯ N*2 å€‹
  const [likes, bookmarks] = await Promise.all([
    this.prisma.like.findMany({
      where: {
        userId: currentUserId,
        postId: { in: postIds },  // â† æ‰¹é‡æŸ¥è©¢
      },
      select: { postId: true },
    }),
    this.prisma.bookmark.findMany({
      where: {
        userId: currentUserId,
        postId: { in: postIds },  // â† æ‰¹é‡æŸ¥è©¢
      },
      select: { postId: true },
    }),
  ]);

  // ç”¨ Set å¿«é€ŸæŸ¥æ‰¾
  const likedPostIds = new Set(likes.map(l => l.postId));
  const bookmarkedPostIds = new Set(bookmarks.map(b => b.postId));

  postsWithInteractions = posts.map(post => ({
    ...post,
    isLiked: likedPostIds.has(post.id),
    isBookmarked: bookmarkedPostIds.has(post.id),
  }));
}
```

**2. ä½¿ç”¨é€£æ¥é‡è©¦åŒ…è£**ï¼š
```typescript
// âœ… æ•´å€‹æ–¹æ³•åŒ…è£¹åœ¨ executeWithRetry ä¸­
async getPosts(query: PostQueryDto, currentUserId?: string) {
  return await this.prisma.executeWithRetry(async () => {
    // æ‰€æœ‰æŸ¥è©¢é‚è¼¯
    const [posts, total] = await Promise.all([...]);
    // ...
    return { success: true, data: {...} };
  });
}
```

**å¯¦éš›ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
```bash
backend/src/posts/posts.service.ts
  - getPosts() æ–¹æ³•ï¼šæ‰¹é‡æŸ¥è©¢ + executeWithRetry åŒ…è£
  - getPost() æ–¹æ³•ï¼šexecuteWithRetry åŒ…è£
```

**æ€§èƒ½å°æ¯”**ï¼š

| æ–¹æ³• | 10 ç¯‡æ–‡ç« çš„æŸ¥è©¢æ•¸ | é€£æ¥æ± å£“åŠ› |
|-----|-----------------|----------|
| âŒ N+1 æŸ¥è©¢ | 22 å€‹æŸ¥è©¢ | **è¶…éé™åˆ¶** (20 connections) |
| âœ… æ‰¹é‡æŸ¥è©¢ | 4 å€‹æŸ¥è©¢ | **æ­£å¸¸** (é ä½æ–¼é™åˆ¶) |

**é©—è­‰æ­¥é©Ÿ**ï¼š

```bash
# 1. é‡æ–°ç·¨è­¯
cd backend && npm run build

# 2. é‡å•Ÿå¾Œç«¯
pkill -9 -f "node.*dist/main" && npm run start:prod

# 3. æ¸¬è©¦ APIï¼ˆæ‡‰ç«‹å³è¿”å›ï¼‰
time curl -s "http://localhost:5000/api/posts?page=1&limit=10" | jq .success
# æ‡‰è©² < 1 ç§’ä¸¦è¿”å› true

# 4. é€£çºŒæ¸¬è©¦ 10 æ¬¡ï¼ˆæª¢æŸ¥é€£æ¥æ± ç©©å®šæ€§ï¼‰
for i in {1..10}; do 
  curl -s "http://localhost:5000/api/posts?page=1&limit=2" > /dev/null
  echo "Test $i completed"
done

# 5. æª¢æŸ¥å¾Œç«¯æ—¥èªŒç„¡éŒ¯èª¤
tail -30 backend/backend.log | grep -i error
# æ‡‰è©²æ²’æœ‰ P2024 éŒ¯èª¤
```

**æ¸¬è©¦çµæœ**ï¼š
```json
{
  "success": true,
  "message": "Posts retrieved successfully",
  "data": {
    "posts": [
      {
        "id": "...",
        "title": "è®€æ›¸åˆ†äº«ï¼šåŸå­ç¿’æ…£",
        "author": {"username": "bob", ...},
        "isLiked": false,       // âœ… æ­£ç¢ºè¿”å›
        "isBookmarked": false   // âœ… æ­£ç¢ºè¿”å›
      }
    ],
    "pagination": {...}
  }
}
```

**é—œéµå­¸ç¿’é»**ï¼š

1. **N+1 æŸ¥è©¢å±å®³**
   - åœ¨å¾ªç’°ä¸­åŸ·è¡ŒæŸ¥è©¢æœƒå¿«é€Ÿè€—ç›¡é€£æ¥æ± 
   - æ‡‰è©²æ‰¹é‡æŸ¥è©¢ç„¶å¾Œåœ¨å…§å­˜ä¸­æ˜ å°„

2. **é€£æ¥æ± é™åˆ¶**
   - Session Pooler æœ‰é€£æ¥æ•¸é™åˆ¶ï¼ˆæœ¬é …ç›®ï¼š20ï¼‰
   - ä¸¦ç™¼æŸ¥è©¢æ•¸ä¸æ‡‰æ¥è¿‘æˆ–è¶…éé™åˆ¶

3. **æ‰¹é‡æŸ¥è©¢å„ªåŒ–**
   ```sql
   -- âŒ N+1: åŸ·è¡Œ N æ¬¡
   SELECT * FROM likes WHERE userId=? AND postId=?
   
   -- âœ… æ‰¹é‡: åŸ·è¡Œ 1 æ¬¡
   SELECT * FROM likes WHERE userId=? AND postId IN (?,?,?,...)
   ```

4. **ä½¿ç”¨ Set å„ªåŒ–æŸ¥æ‰¾**
   - `Array.includes()`: O(n)
   - `Set.has()`: O(1)
   - 10 ç¯‡æ–‡ç« ï¼šSet å¿« 10 å€

5. **ç¸½æ˜¯ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶**
   - ç¶²çµ¡æ³¢å‹•æ™‚è‡ªå‹•é‡è©¦
   - é€£æ¥æ± æš«æ™‚è€—ç›¡æ™‚ç­‰å¾…é‡è©¦
   - é¿å…ç¬æ™‚éŒ¯èª¤å°è‡´è«‹æ±‚å¤±æ•—

**ç›¸é—œå•é¡Œ**ï¼š
- Â§ 3.4: é€£æ¥æ± è¶…æ™‚ï¼ˆå¢åŠ é€£æ¥æ•¸ï¼‰
- Â§ 3.5: N+1 æŸ¥è©¢ï¼ˆæœ¬ç¯€ - æ¸›å°‘æŸ¥è©¢æ•¸ï¼‰
- Â§ 2.3: API è¶…æ™‚é…ç½®

**æœ€ä½³å¯¦è¸**ï¼š
```typescript
// âœ… Service æ–¹æ³•çš„æ¨™æº–æ¨¡å¼
async getSomething(query, userId?) {
  return await this.prisma.executeWithRetry(async () => {
    // 1. ä¸»æŸ¥è©¢ï¼ˆç›¡é‡ç”¨ include é åŠ è¼‰ï¼‰
    const items = await this.prisma.model.findMany({
      include: { relation: true }  // â† é åŠ è¼‰é—œè¯
    });
    
    // 2. æ‰¹é‡æŸ¥è©¢é¡å¤–æ•¸æ“šï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (userId && items.length > 0) {
      const itemIds = items.map(i => i.id);
      const additionalData = await this.prisma.other.findMany({
        where: { itemId: { in: itemIds } }  // â† æ‰¹é‡æŸ¥è©¢
      });
    }
    
    // 3. åœ¨å…§å­˜ä¸­çµ„åˆçµæœ
    return items.map(item => ({...}));
  });
}
```

---

**è¨˜éŒ„æ™‚é–“**: 2025-11-02 01:45
**ç‹€æ…‹**: âœ… å•é¡Œå·²å®Œå…¨è§£æ±º
**è§£æ±ºæ–¹æ¡ˆ**: N+1 æŸ¥è©¢å„ªåŒ– + æ‰¹é‡æŸ¥è©¢ + executeWithRetry åŒ…è£
**ä¿®å¾©è€—æ™‚**: ç´„ 30 åˆ†é˜ï¼ˆè¨ºæ–· 15 åˆ†é˜ + ä¿®å¾© 15 åˆ†é˜ï¼‰
**é©ç”¨ç’°å¢ƒ**: æ‰€æœ‰ä½¿ç”¨ Prisma çš„ Node.js æ‡‰ç”¨
**æ€§èƒ½æå‡**: å¾ 22 å€‹ä¸¦ç™¼æŸ¥è©¢é™è‡³ 4 å€‹ï¼ˆ**é™ä½ 82% é€£æ¥ä½¿ç”¨**ï¼‰

---

## 4. å¿«å–èˆ‡ç€è¦½å™¨å•é¡Œ

### 4.1 ä»£ç¢¼å·²ä¿®æ”¹ä½†ç€è¦½å™¨ä»é¡¯ç¤ºèˆŠç‰ˆæœ¬

**å•é¡Œç¾è±¡**ï¼š
- ä¿®æ”¹äº†ä»£ç¢¼ä¸¦é‡å•Ÿæœå‹™
- ç€è¦½å™¨ä»ç„¶åŸ·è¡ŒèˆŠä»£ç¢¼
- éŒ¯èª¤ä¾ç„¶å­˜åœ¨

**åŸå› **ï¼š
ç€è¦½å™¨å¿«å–äº†èˆŠçš„ JavaScript bundle

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šç¡¬é‡è¼‰ï¼ˆæœ€å¿«ï¼‰**
```
Windows/Linux: Ctrl + Shift + R
Mac: Cmd + Shift + R
```

**æ–¹æ¡ˆ Bï¼šå®Œå…¨æ¸…é™¤å¿«å–**
1. æ‰“é–‹ DevTools (F12)
2. å³éµé»æ“Šé‡æ–°æ•´ç†æŒ‰éˆ•
3. é¸æ“‡ã€Œæ¸…é™¤å¿«å–ä¸¦å¼·åˆ¶é‡æ–°æ•´ç†ã€

**æ–¹æ¡ˆ Cï¼šæ¸…é™¤æ‰€æœ‰ç¶²ç«™æ•¸æ“š**
1. DevTools â†’ Application æ¨™ç±¤
2. Storage â†’ Clear storage
3. é»æ“Šã€ŒClear site dataã€
4. é—œé–‰ä¸¦é‡æ–°æ‰“é–‹ç€è¦½å™¨

**æ–¹æ¡ˆ Dï¼šé–‹ç™¼æ™‚ç¦ç”¨å¿«å–**
1. æ‰“é–‹ DevTools (F12)
2. Network æ¨™ç±¤
3. å‹¾é¸ã€ŒDisable cacheã€
4. ä¿æŒ DevTools é–‹å•Ÿç‹€æ…‹

**æ–¹æ¡ˆ Eï¼šæ¸…é™¤ Metro bundler å¿«å–**
```bash
cd frontend
rm -rf .expo .expo-shared node_modules/.cache
npm start -- --clear
```

**é é˜²æªæ–½**ï¼š
- é–‹ç™¼æ™‚å§‹çµ‚ä¿æŒ DevTools é–‹å•Ÿä¸¦ç¦ç”¨å¿«å–
- å®šæœŸæ¸…é™¤ Metro bundler å¿«å–
- ä½¿ç”¨ç‰ˆæœ¬è™Ÿæˆ– hash é˜²æ­¢ç”Ÿç”¢ç’°å¢ƒå¿«å–å•é¡Œ

---

### 4.2 Service Worker å°è‡´æ›´æ–°ç„¡æ•ˆ

**å•é¡Œç¾è±¡**ï¼š
- éƒ¨ç½²æ–°ç‰ˆæœ¬å¾Œç”¨æˆ¶ä»çœ‹åˆ°èˆŠç‰ˆæœ¬
- éœ€è¦å¤šæ¬¡é‡æ–°æ•´ç†æ‰èƒ½çœ‹åˆ°æ›´æ–°

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// é…ç½® service worker æ›´æ–°ç­–ç•¥
// frontend/src/serviceWorkerRegistration.ts
export function register(config) {
  window.addEventListener('load', () => {
    const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;
    
    navigator.serviceWorker.register(swUrl).then(registration => {
      registration.onupdatefound = () => {
        const installingWorker = registration.installing;
        installingWorker.onstatechange = () => {
          if (installingWorker.state === 'installed') {
            if (navigator.serviceWorker.controller) {
              // æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæç¤ºç”¨æˆ¶é‡æ–°æ•´ç†
              console.log('New content available; please refresh.');
            }
          }
        };
      };
    });
  });
}
```

---

## 5. React Native èˆ‡ Expo å•é¡Œ

### 5.1 Expo ç·¨è­¯éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Error: Unable to resolve module...
```

**è§£æ±ºæ­¥é©Ÿ**ï¼š
```bash
# 1. æ¸…é™¤å¿«å–
cd frontend
rm -rf .expo .expo-shared node_modules/.cache

# 2. é‡æ–°å®‰è£ä¾è³´
rm -rf node_modules
npm install

# 3. é‡å•Ÿ Metro bundler
npm start -- --clear

# 4. å¦‚æœä»ç„¶å¤±æ•—ï¼Œæª¢æŸ¥å°å…¥è·¯å¾‘
# ç¢ºä¿æ–‡ä»¶å­˜åœ¨ä¸”è·¯å¾‘æ­£ç¢º
```

---

### 5.2 React Native å»¢æ£„è­¦å‘Š

**è­¦å‘Šè¨Šæ¯**ï¼š
```
Warning: props.pointerEvents is deprecated
Warning: "shadow*" style props are deprecated
Warning: useNativeDriver not supported
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**pointerEvents å»¢æ£„**
```tsx
// âŒ èˆŠå¯«æ³•
<View pointerEvents="none" />

// âœ… æ–°å¯«æ³•
<View style={{ pointerEvents: 'none' }} />
```

**shadow å±¬æ€§å»¢æ£„**
```tsx
// âŒ èˆŠå¯«æ³•
<View
  shadowColor="#000"
  shadowOffset={{ width: 0, height: 2 }}
  shadowOpacity={0.25}
  shadowRadius={3.84}
/>

// âœ… æ–°å¯«æ³•
<View style={{ boxShadow: '0px 2px 3.84px rgba(0, 0, 0, 0.25)' }} />
```

**useNativeDriver è­¦å‘Š**
```typescript
// æ·»åŠ æ¢ä»¶æª¢æŸ¥
Animated.timing(animation, {
  toValue: 1,
  duration: 300,
  useNativeDriver: Platform.OS !== 'web', // Web ä¸æ”¯æ´
}).start();
```

---

### 5.3 Cannot read properties of undefined

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
TypeError: Cannot read properties of undefined (reading 'property')
```

**å•é¡ŒåŸå› **ï¼š
å˜—è©¦è¨ªå• undefined æˆ– null å°è±¡çš„å±¬æ€§

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šä½¿ç”¨å¯é¸éˆï¼ˆæ¨è–¦ï¼‰**
```typescript
// âŒ éŒ¯èª¤
const value = response.data.history;

// âœ… æ­£ç¢º
const value = response.data?.history || [];
```

**æ–¹æ¡ˆ Bï¼šæ·»åŠ é¡å‹æª¢æŸ¥**
```typescript
if (response && response.data && response.data.history) {
  const history = response.data.history;
}
```

**æ–¹æ¡ˆ Cï¼šä½¿ç”¨ TypeScript åš´æ ¼æ¨¡å¼**
```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "strictNullChecks": true
  }
}
```

---

### 5.4 react-native-maps Web å…¼å®¹æ€§å•é¡Œï¼ˆcodegenNativeComponent is not a functionï¼‰

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Error: (0 , _reactNativeWebDistIndex.codegenNativeComponent) is not a function
```

**å•é¡Œç¾è±¡**ï¼š
- Web ç€è¦½å™¨ç„¡æ³•æ­£å¸¸åŠ è¼‰æ‡‰ç”¨
- é é¢é¡¯ç¤ºç©ºç™½
- æ§åˆ¶å°å ±éŒ¯ `codegenNativeComponent is not a function`
- ç§»å‹•ç«¯ï¼ˆiOS/Androidï¼‰é‹è¡Œæ­£å¸¸

**å•é¡ŒåŸå› **ï¼š
- `react-native-maps` çµ„ä»¶ä¸æ”¯æŒ Web å¹³å°
- MapView æ˜¯åŸç”Ÿçµ„ä»¶ï¼Œéœ€è¦ iOS/Android åŸç”Ÿä»£ç¢¼
- åœ¨ Web ç’°å¢ƒä¸­å°å…¥ `react-native-maps` æœƒå°è‡´æ‡‰ç”¨å´©æ½°
- å½±éŸ¿çµ„ä»¶ï¼š
  - `LocationPicker.tsx` - åœ°åœ–ä½ç½®é¸æ“‡å™¨
  - `MapPreview.tsx` - åœ°åœ–é è¦½çµ„ä»¶
  - `MapSearchScreen.tsx` - åœ°åœ–æœå°‹ç•«é¢

**è¨ºæ–·æ­¥é©Ÿ**ï¼š
```bash
# 1. æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤
# æ‰“é–‹ http://localhost:8081 
# F12 â†’ Console

# 2. æœå°‹ä½¿ç”¨ MapView çš„æ–‡ä»¶
cd frontend/src
grep -r "from 'react-native-maps'" .

# 3. æª¢æŸ¥å¹³å°æª¢æ¸¬
grep -r "Platform.OS" components/
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šæ¢ä»¶å°å…¥ + å¹³å°æª¢æ¸¬ï¼ˆæ¨è–¦ï¼‰**

```typescript
// LocationPicker.tsx
import React, { useState, useEffect } from 'react';
import { View, StyleSheet, Platform } from 'react-native';
import { Text, Button } from 'react-native-paper';

// Region é¡å‹å®šç¾©
interface Region {
  latitude: number;
  longitude: number;
  latitudeDelta: number;
  longitudeDelta: number;
}

// æ¢ä»¶å°å…¥ MapViewï¼ˆåƒ…åœ¨é Web å¹³å°ï¼‰
let MapView: any = null;
let Marker: any = null;

if (Platform.OS !== 'web') {
  const MapModule = require('react-native-maps');
  MapView = MapModule.default;
  Marker = MapModule.Marker;
}

export function LocationPicker({ /* props */ }) {
  // ... state declarations

  return (
    <Portal>
      <Modal>
        {/* ... header and search */}
        
        {/* åœ°åœ–å®¹å™¨ */}
        <View style={styles.mapContainer}>
          {Platform.OS === 'web' ? (
            // Web å¹³å°æ›¿ä»£ UI
            <View style={[styles.webFallback, { backgroundColor: theme.colors.surfaceVariant }]}>
              <Text variant="titleMedium">ğŸ—ºï¸ åœ°åœ–é¸æ“‡å™¨</Text>
              <Text variant="bodyMedium" style={{ textAlign: 'center', marginTop: 8 }}>
                åœ°åœ–åŠŸèƒ½åœ¨ç¶²é ç‰ˆä¸­ä¸å¯ç”¨
              </Text>
              <Text variant="bodySmall" style={{ textAlign: 'center', color: theme.colors.onSurfaceVariant }}>
                è«‹åœ¨è¡Œå‹•è£ç½®ä¸Šä½¿ç”¨æ­¤åŠŸèƒ½
              </Text>
              {locationInfo && (
                <View style={styles.webLocationInfo}>
                  <Text>ğŸ“ {locationInfo.placeName}</Text>
                  <Text>åº§æ¨™: {latitude}, {longitude}</Text>
                </View>
              )}
            </View>
          ) : (
            // ç§»å‹•ç«¯ MapView
            MapView && (
              <MapView
                style={styles.map}
                region={region}
                onRegionChangeComplete={setRegion}
                onPress={handleMapPress}
              >
                {Marker && (
                  <Marker
                    coordinate={markerPosition}
                    draggable
                    onDragEnd={handleMarkerDragEnd}
                  />
                )}
              </MapView>
            )
          )}
        </View>
        
        {/* ... info and buttons */}
      </Modal>
    </Portal>
  );
}

// æ·»åŠ  Web fallback æ¨£å¼
const styles = StyleSheet.create({
  // ... existing styles
  webFallback: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
    borderRadius: 8,
  },
  webLocationInfo: {
    marginTop: 16,
    padding: 12,
    backgroundColor: 'rgba(255,255,255,0.1)',
    borderRadius: 8,
    alignItems: 'center',
  },
});
```

**æ–¹æ¡ˆ Bï¼šMapPreview çµ„ä»¶**

```typescript
// MapPreview.tsx
import { Platform } from 'react-native';

// æ¢ä»¶å°å…¥
let MapView: any = null;
let Marker: any = null;

if (Platform.OS !== 'web') {
  const MapModule = require('react-native-maps');
  MapView = MapModule.default;
  Marker = MapModule.Marker;
}

export function MapPreview({ location, onPress, height = 150 }) {
  return (
    <TouchableOpacity onPress={onPress} style={[styles.mapContainer, { height }]}>
      {Platform.OS === 'web' ? (
        // Web å¹³å°ç°¡åŒ–é è¦½
        <View style={[styles.webFallback, { backgroundColor: theme.colors.surfaceVariant }]}>
          <Text variant="titleMedium">ğŸ—ºï¸</Text>
          <Text variant="bodySmall" style={{ marginTop: 8 }}>
            {location.placeName}
          </Text>
          <Text variant="bodySmall" style={{ fontSize: 10 }}>
            {location.latitude.toFixed(4)}, {location.longitude.toFixed(4)}
          </Text>
        </View>
      ) : (
        // ç§»å‹•ç«¯ MapView
        MapView && (
          <MapView
            style={styles.map}
            initialRegion={{
              latitude: location.latitude,
              longitude: location.longitude,
              latitudeDelta: 0.01,
              longitudeDelta: 0.01,
            }}
            scrollEnabled={false}
            zoomEnabled={false}
          >
            {Marker && (
              <Marker
                coordinate={{
                  latitude: location.latitude,
                  longitude: location.longitude,
                }}
              />
            )}
          </MapView>
        )
      )}
    </TouchableOpacity>
  );
}

const styles = StyleSheet.create({
  // ... existing styles
  webFallback: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
});
```

**æ–¹æ¡ˆ Cï¼šMapSearchScreen ç•«é¢ç´šè™•ç†**

```typescript
// MapSearchScreen.tsx
import { Platform } from 'react-native';
import { Button } from 'react-native-paper';

export default function MapSearchScreen({ navigation }: Props) {
  const { theme } = useAppTheme();
  
  // Web å¹³å°ç›´æ¥è¿”å›æç¤ºç•«é¢
  if (Platform.OS === 'web') {
    return (
      <SafeAreaLayout>
        <View style={styles.container}>
          <Surface style={[styles.toolbar, { backgroundColor: theme.colors.surface }]}>
            <IconButton icon="arrow-left" onPress={() => navigation.goBack()} />
            <Text variant="titleMedium">åœ°åœ–æœå°‹</Text>
          </Surface>
          <View style={styles.webNotice}>
            <Text variant="headlineMedium">ğŸ—ºï¸</Text>
            <Text variant="titleLarge" style={{ marginBottom: 8 }}>
              åœ°åœ–æœå°‹åŠŸèƒ½
            </Text>
            <Text variant="bodyLarge" style={{ textAlign: 'center', marginBottom: 16 }}>
              æ­¤åŠŸèƒ½åƒ…é©ç”¨æ–¼è¡Œå‹•è£ç½®
            </Text>
            <Text variant="bodyMedium" style={{ textAlign: 'center' }}>
              è«‹ä½¿ç”¨ iOS æˆ– Android è¨­å‚™è¨ªå•æ­¤åŠŸèƒ½
            </Text>
            <Button 
              mode="contained" 
              onPress={() => navigation.goBack()}
              style={{ marginTop: 24 }}
            >
              è¿”å›
            </Button>
          </View>
        </View>
      </SafeAreaLayout>
    );
  }
  
  // ç§»å‹•ç«¯æ­£å¸¸é‚è¼¯
  // ...
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  webNotice: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 32,
  },
  // ... other styles
});
```

**é©—è­‰æ¸¬è©¦**ï¼š

```bash
# 1. æ¸…é™¤å¿«å–
cd frontend
rm -rf .expo node_modules/.cache

# 2. é‡å•Ÿé–‹ç™¼æœå‹™å™¨
npm start

# 3. åœ¨ç€è¦½å™¨æ¸¬è©¦
# æ‰“é–‹ http://localhost:8081
# æ‡‰è©²èƒ½çœ‹åˆ°ç™»å…¥ç•«é¢ï¼Œä¸å†æœ‰ codegenNativeComponent éŒ¯èª¤

# 4. æ¸¬è©¦åœ°åœ–ç›¸é—œåŠŸèƒ½
# - å‰µå»ºæ–‡ç« æ™‚æ·»åŠ ä½ç½® â†’ æ‡‰é¡¯ç¤º Web fallback UI
# - æŸ¥çœ‹åŒ…å«ä½ç½®çš„æ–‡ç«  â†’ æ‡‰é¡¯ç¤ºç°¡åŒ–åœ°åœ–é è¦½
# - è¨ªå•åœ°åœ–æœå°‹ â†’ æ‡‰é¡¯ç¤ºã€Œåƒ…é©ç”¨æ–¼è¡Œå‹•è£ç½®ã€æç¤º

# 5. åœ¨ç§»å‹•æ¨¡æ“¬å™¨æ¸¬è©¦ï¼ˆç¢ºä¿åŸç”ŸåŠŸèƒ½æ­£å¸¸ï¼‰
# iOS: Press i
# Android: Press a
```

**ç›¸é—œæ–‡ä»¶**ï¼š
- `frontend/src/components/common/LocationPicker.tsx`
- `frontend/src/components/common/MapPreview.tsx`
- `frontend/src/screens/MapSearchScreen.tsx`
- `frontend/src/screens/CreatePostScreen.tsx`

**ä¿®å¾©æ•ˆæœ**ï¼š

**ç§»å‹•ç«¯ (iOS/Android)**:
- âœ… å®Œæ•´ MapView åŠŸèƒ½
- âœ… åœ°åœ–é¸æ“‡å™¨æ­£å¸¸å·¥ä½œ
- âœ… åœ°åœ–é è¦½æ­£å¸¸é¡¯ç¤º
- âœ… åœ°åœ–æœå°‹åŠŸèƒ½å®Œæ•´

**Web ç«¯**:
- âœ… ä¸å†å´©æ½°
- âœ… é¡¯ç¤ºå‹å¥½æç¤º UI
- âœ… ä¿ç•™åŸºæœ¬ä½ç½®ä¿¡æ¯é¡¯ç¤º
- âœ… æä¾›è¿”å›é¸é …

**æ³¨æ„äº‹é …**ï¼š
1. æ¢ä»¶å°å…¥å¿…é ˆåœ¨çµ„ä»¶å¤–éƒ¨é€²è¡Œï¼Œä¸èƒ½åœ¨ render å…§éƒ¨
2. ä½¿ç”¨ `Platform.OS !== 'web'` è€Œé `Platform.OS === 'ios'`ï¼Œä»¥æ”¯æŒ Android
3. ç‚º Web æä¾›æœ‰æ„ç¾©çš„æ›¿ä»£ UIï¼Œä¸è¦ç•™ç©ºç™½
4. æ¸¬è©¦æ™‚ç¢ºä¿ç§»å‹•ç«¯åŠŸèƒ½æœªå—å½±éŸ¿

**æ›¿ä»£æ–¹æ¡ˆï¼ˆé«˜ç´šï¼‰**ï¼š

å¦‚æœéœ€è¦åœ¨ Web ä¸Šä¹Ÿé¡¯ç¤ºåœ°åœ–ï¼Œå¯ä»¥è€ƒæ…®ï¼š

**ä½¿ç”¨ React Leafletï¼ˆWeb å°ˆç”¨åœ°åœ–ï¼‰**
```bash
npm install react-leaflet leaflet
```

```typescript
// MapView.web.tsx
import { MapContainer, TileLayer, Marker } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';

export function MapView({ region, children }) {
  return (
    <MapContainer 
      center={[region.latitude, region.longitude]} 
      zoom={13}
      style={{ height: '100%', width: '100%' }}
    >
      <TileLayer
        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
      />
      {children}
    </MapContainer>
  );
}
```

**è¨˜éŒ„æ™‚é–“**ï¼š2025-11-03 23:50  
**è§£æ±ºæ™‚é•·**ï¼š1 å°æ™‚  
**å„ªå…ˆç´š**ï¼šğŸ”´é«˜ï¼ˆé˜»å¡ Web æ¸¬è©¦ï¼‰

---

## 6. TypeScript é¡å‹å•é¡Œ

### 6.1 Type 'never' éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Argument of type '[never, never]' is not assignable to parameter of type 'never'
```

**å•é¡ŒåŸå› **ï¼š
TypeScript ç„¡æ³•æ¨æ–· navigation çš„é¡å‹

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šå®šç¾©å°èˆªé¡å‹**
```typescript
// frontend/src/types/navigation.ts
import { NativeStackNavigationProp } from '@react-navigation/native-stack';

export type RootStackParamList = {
  Home: undefined;
  Search: undefined;
  Profile: { userId: string };
  TagPosts: { slug: string };
};

export type NavigationProp = NativeStackNavigationProp<RootStackParamList>;
```

**æ–¹æ¡ˆ Bï¼šä½¿ç”¨é¡å‹æ–·è¨€ï¼ˆè‡¨æ™‚æ–¹æ¡ˆï¼‰**
```typescript
// ä¸æ¨è–¦ï¼Œä½†å¯ä»¥å¿«é€Ÿä¿®å¾©ç·¨è­¯éŒ¯èª¤
navigation.navigate('Profile' as never, { userId: user.id } as never);
```

**æ–¹æ¡ˆ Cï¼šæ­£ç¢ºä½¿ç”¨ï¼ˆæ¨è–¦ï¼‰**
```typescript
import { useNavigation } from '@react-navigation/native';
import type { NavigationProp } from '../types/navigation';

const navigation = useNavigation<NavigationProp>();

// ç¾åœ¨å¯ä»¥æ­£ç¢ºä½¿ç”¨
navigation.navigate('Profile', { userId: user.id });
```

---

## 7. ç’°å¢ƒé…ç½®å•é¡Œ

### 7.1 ç’°å¢ƒè®Šæ•¸è®€å–å¤±æ•—

**å•é¡Œç¾è±¡**ï¼š
- `process.env.VARIABLE` è¿”å› undefined
- é…ç½®å€¼æœªæ­£ç¢ºè¼‰å…¥

**è¨ºæ–·**ï¼š
```bash
# æª¢æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la backend/.env

# æª¢æŸ¥å…§å®¹
cat backend/.env
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**ç¢ºèª .env æ–‡ä»¶æ ¼å¼**
```env
# âœ… æ­£ç¢ºæ ¼å¼
DATABASE_URL="postgresql://..."
JWT_SECRET="your-secret-key"
PORT=5000

# âŒ éŒ¯èª¤æ ¼å¼ï¼ˆæœ‰ç©ºæ ¼ï¼‰
DATABASE_URL = "postgresql://..."

# âŒ éŒ¯èª¤æ ¼å¼ï¼ˆæœ‰è¨»é‡‹åœ¨åŒä¸€è¡Œï¼‰
PORT=5000 # ç«¯å£è™Ÿ
```

**é‡å•Ÿæœå‹™è¼‰å…¥ç’°å¢ƒè®Šæ•¸**
```bash
# ä¿®æ”¹ .env å¾Œå¿…é ˆé‡å•Ÿ
pkill -9 -f "nest|node.*backend"
cd backend && npm run start:dev
```

---

### 7.2 ç«¯å£å·²è¢«ä½”ç”¨

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Error: listen EADDRINUSE: address already in use :::5000
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šæŸ¥æ‰¾ä¸¦çµ‚æ­¢é€²ç¨‹**
```bash
# æŸ¥æ‰¾ä½”ç”¨ç«¯å£çš„é€²ç¨‹
lsof -i :5000
# æˆ–
netstat -ano | grep :5000

# çµ‚æ­¢é€²ç¨‹
kill -9 [PID]
```

**æ–¹æ¡ˆ Bï¼šæ›´æ›ç«¯å£**
```env
# backend/.env
PORT=5001
```

**æ–¹æ¡ˆ Cï¼šä¸€éµæ¸…ç†æ‰€æœ‰ç›¸é—œé€²ç¨‹**
```bash
# æ¸…ç†å¾Œç«¯é€²ç¨‹
pkill -9 -f "nest|node.*backend"

# æ¸…ç†å‰ç«¯é€²ç¨‹
pkill -9 -f "expo|metro"
```

---

## å¿«é€Ÿè¨ºæ–·æª¢æŸ¥æ¸…å–®

ç•¶é‡åˆ°å•é¡Œæ™‚ï¼ŒæŒ‰é †åºæª¢æŸ¥ï¼š

### âœ… åŸºç¤æª¢æŸ¥
- [ ] æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œï¼ˆ`ps aux | grep node`ï¼‰
- [ ] ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºè¼‰å…¥ï¼ˆæª¢æŸ¥ .envï¼‰
- [ ] æ˜¯å¦æœ‰æ‹¼å¯«éŒ¯èª¤
- [ ] æ˜¯å¦ä¿®æ”¹äº†æ­£ç¢ºçš„æ–‡ä»¶

### âœ… å¿«å–æª¢æŸ¥
- [ ] æ¸…é™¤ç€è¦½å™¨å¿«å–ï¼ˆCtrl+Shift+Rï¼‰
- [ ] æ¸…é™¤ Metro bundler å¿«å–
- [ ] æ¸…é™¤ node_modules/.cache

### âœ… é…ç½®æª¢æŸ¥
- [ ] API baseURL é…ç½®æ­£ç¢º
- [ ] å°èˆªé…ç½®å®Œæ•´
- [ ] é¡å‹å®šç¾©æ­£ç¢º

### âœ… ç¶²è·¯æª¢æŸ¥
- [ ] å¾Œç«¯ API ç›´æ¥æ¸¬è©¦æ­£å¸¸ï¼ˆcurlï¼‰
- [ ] CORS é…ç½®æ­£ç¢º
- [ ] é˜²ç«ç‰†æœªé˜»æ“‹è«‹æ±‚

### âœ… æ—¥èªŒæª¢æŸ¥
- [ ] æŸ¥çœ‹å¾Œç«¯æ§åˆ¶å°è¼¸å‡º
- [ ] æŸ¥çœ‹ç€è¦½å™¨ Console
- [ ] æŸ¥çœ‹ç€è¦½å™¨ Network æ¨™ç±¤

---

## å¸¸ç”¨è¨ºæ–·å‘½ä»¤

```bash
# æŸ¥çœ‹é€²ç¨‹
ps aux | grep -E "node|expo|metro|nest"

# æŸ¥çœ‹ç«¯å£ä½”ç”¨
lsof -i :5000
lsof -i :8081

# æ¸¬è©¦ API
curl -v http://localhost:5000/api/posts

# æ¸…é™¤æ‰€æœ‰å¿«å–
cd frontend
rm -rf .expo .expo-shared node_modules/.cache
cd ../backend
rm -rf dist

# é‡å•Ÿæ‰€æœ‰æœå‹™
pkill -9 -f "node|expo|metro|nest"
cd backend && npm run start:dev &
cd frontend && npm start &

# æª¢æŸ¥æ–‡ä»¶ç·¨ç¢¼
file frontend/App.tsx

# æœå°‹é‡è¤‡æ–‡ä»¶
find . -name "App.tsx"

# æœå°‹å¯èƒ½çš„å•é¡Œè·¯å¾‘
grep -r "apiClient.get(\`/api/" frontend/src/
```

---

## æ·»åŠ æ–°å•é¡Œè¨˜éŒ„æ¨¡æ¿

```markdown
### X.X å•é¡Œæ¨™é¡Œ

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
åœ¨æ­¤è²¼ä¸Šå®Œæ•´éŒ¯èª¤è¨Šæ¯
```

**å•é¡Œç¾è±¡**ï¼š
- æè¿°å•é¡Œå¦‚ä½•ç™¼ç”Ÿ
- é‡ç¾æ­¥é©Ÿ

**å•é¡ŒåŸå› **ï¼š
è§£é‡‹ç‚ºä»€éº¼æœƒç™¼ç”Ÿé€™å€‹å•é¡Œ

**è¨ºæ–·æ­¥é©Ÿ**ï¼š
1. ç¬¬ä¸€æ­¥è¨ºæ–·æ–¹æ³•
2. ç¬¬äºŒæ­¥è¨ºæ–·æ–¹æ³•

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šæ¨è–¦æ–¹æ¡ˆ**
```bash
# å‘½ä»¤æˆ–ä»£ç¢¼
```

**æ–¹æ¡ˆ Bï¼šæ›¿ä»£æ–¹æ¡ˆ**
```bash
# å‘½ä»¤æˆ–ä»£ç¢¼
```

**é©—è­‰ä¿®å¾©**ï¼š
```bash
# å¦‚ä½•ç¢ºèªå•é¡Œå·²è§£æ±º
```

**é é˜²æªæ–½**ï¼š
- å¦‚ä½•é¿å…æœªä¾†å†æ¬¡ç™¼ç”Ÿ

**ç›¸é—œè¨˜éŒ„**ï¼š
- æ—¥æœŸï¼šé¦–æ¬¡é‡åˆ°æ™‚é–“
- ç›¸é—œæ–‡ä»¶æˆ–æäº¤
```

---

## æ›´æ–°æ—¥èªŒ

### 2025-11-02
- âœ… æ·»åŠ æ•…éšœæ’æŸ¥æ¨™æº–æµç¨‹
- âœ… æ·»åŠ å•é¡Œè¨˜éŒ„æ¨¡æ¿
- âœ… æ·»åŠ å¿«é€Ÿæœå°‹é—œéµå­—è¡¨
- âœ… æ·»åŠ æœ€è¿‘è§£æ±ºå•é¡Œè¿½è¹¤
- âœ… å»ºç«‹çŸ¥è­˜åº«ç®¡ç†è¦ç¯„

### 2025-11-01
- âœ… å‰µå»ºå•é¡Œæ’æŸ¥æ–‡æª”
- âœ… æ·»åŠ å°èˆªå•é¡Œï¼ˆé›™æ–‡ä»¶å•é¡Œï¼‰
- âœ… æ·»åŠ  API è·¯å¾‘å•é¡Œ
- âœ… æ·»åŠ å‰ç«¯ 500 éŒ¯èª¤è¨ºæ–·
- âœ… æ·»åŠ å¿«å–å•é¡Œè§£æ±ºæ–¹æ¡ˆ
- âœ… æ·»åŠ  React Native å¸¸è¦‹å•é¡Œ
- âœ… æ·»åŠ  TypeScript é¡å‹å•é¡Œ
- âœ… æ·»åŠ ç’°å¢ƒé…ç½®å•é¡Œ
- âœ… **é‡é»ï¼šæ·»åŠ  Prisma P1001 éŒ¯èª¤ - WSL2 + Supabase å®Œæ•´è§£æ±ºæ–¹æ¡ˆ**

---

## ğŸ“Š æœ€è¿‘è§£æ±ºçš„å•é¡Œï¼ˆæŒ‰æ™‚é–“å€’åºï¼‰

### ğŸ¯ 2025-11-01: Prisma P1001 - WSL2 ç„¡æ³•é€£æ¥ Supabase â­

**å•é¡Œ**: å¾Œç«¯ç„¡æ³•é€£æ¥æ•¸æ“šåº«ï¼ŒæŒçºŒå‡ºç¾ P1001 éŒ¯èª¤  
**æ ¹æœ¬åŸå› **: WSL2 ä¸æ”¯æŒ IPv6ï¼ŒSupabase Direct Connection åƒ…æ”¯æŒ IPv6  
**è§£æ±ºæ–¹æ¡ˆ**: ä½¿ç”¨ Session Pooler (IPv4 Compatible)  
**è€—æ™‚**: 3 å°æ™‚  
**è©³ç´°è¨˜éŒ„**: è¦‹ [3.3 Prisma P1001 éŒ¯èª¤](#33-prisma-p1001-éŒ¯èª¤---wsl2--supabase-é€£æ¥å•é¡Œ-)  
**é—œéµå­¸ç¿’**: 
- WSL2 ç’°å¢ƒå¿…é ˆä½¿ç”¨ Session Pooler
- ä¸åŒ Pooler é¡å‹çš„ç”¨æˆ¶åæ ¼å¼ä¸åŒ
- ç¶²çµ¡æ¸¬è©¦æˆåŠŸä¸ä»£è¡¨æ‡‰ç”¨é€£æ¥æˆåŠŸ

---

### ğŸ“‹ å•é¡Œè¿½è¹¤çœ‹æ¿

| å•é¡Œ ID | ç‹€æ…‹ | å„ªå…ˆç´š | å•é¡Œç°¡è¿° | è¨˜éŒ„æ—¥æœŸ |
|---------|------|--------|---------|---------|
| #001 | âœ… å·²è§£æ±º | ğŸ”´ é«˜ | Prisma P1001 - WSL2 + Supabase | 2025-11-01 |
| #002 | âœ… å·²è§£æ±º | âš ï¸ ä¸­ | API è·¯å¾‘é‡è¤‡ /api/api/ | 2025-10-XX |
| #003 | âœ… å·²è§£æ±º | âš ï¸ ä¸­ | Screen æœªè¨»å†Šå°èˆªéŒ¯èª¤ | 2025-10-XX |
| - | - | - | (æ–°å•é¡Œè«‹æ·»åŠ åˆ°æ­¤è™•) | - |

---

## ğŸ¤ è²¢ç»æŒ‡å—

### å¦‚ä½•æ·»åŠ æ–°å•é¡Œè¨˜éŒ„

**Step 1: ç¢ºèªå•é¡Œä¸å­˜åœ¨**
```bash
# åœ¨æ–‡æª”ä¸­æœå°‹é—œéµå­—
grep -i "é—œéµéŒ¯èª¤è¨Šæ¯" docs/TROUBLESHOOTING.md
```

**Step 2: é¸æ“‡åˆé©çš„åˆ†é¡**
- å°èˆªèˆ‡è·¯ç”±å•é¡Œ â†’ Section 1
- API èˆ‡ç¶²è·¯è«‹æ±‚å•é¡Œ â†’ Section 2
- è³‡æ–™åº«èˆ‡å¾Œç«¯å•é¡Œ â†’ Section 3
- å¿«å–èˆ‡ç€è¦½å™¨å•é¡Œ â†’ Section 4
- React Native èˆ‡ Expo å•é¡Œ â†’ Section 5
- TypeScript é¡å‹å•é¡Œ â†’ Section 6
- ç’°å¢ƒé…ç½®å•é¡Œ â†’ Section 7

**Step 3: ä½¿ç”¨å•é¡Œè¨˜éŒ„æ¨¡æ¿**

åƒè€ƒä¸Šæ–¹çš„ [ğŸ“ å•é¡Œè¨˜éŒ„æ¨¡æ¿](#-å•é¡Œè¨˜éŒ„æ¨¡æ¿)ï¼Œç¢ºä¿åŒ…å«ï¼š
- âœ… å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯
- âœ… å•é¡Œç¾è±¡æè¿°
- âœ… æ ¹æœ¬åŸå› åˆ†æ
- âœ… è¨ºæ–·æ­¥é©Ÿï¼ˆå¯åŸ·è¡Œå‘½ä»¤ï¼‰
- âœ… è§£æ±ºæ–¹æ¡ˆï¼ˆè‡³å°‘ä¸€å€‹ï¼‰
- âœ… é©—è­‰æ¸¬è©¦æ–¹æ³•

**Step 4: æ›´æ–°è¿½è¹¤çœ‹æ¿**

åœ¨ [ğŸ“Š æœ€è¿‘è§£æ±ºçš„å•é¡Œ](#-æœ€è¿‘è§£æ±ºçš„å•é¡ŒæŒ‰æ™‚é–“å€’åº) ä¸­æ·»åŠ ç°¡è¦è¨˜éŒ„ã€‚

**Step 5: æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶**
```bash
git add docs/TROUBLESHOOTING.md
git commit -m "docs: æ·»åŠ  [å•é¡Œç°¡è¿°] åˆ°æ•…éšœæ’æŸ¥æŒ‡å—"
git push
```

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### å•é¡Œè¨ºæ–·çš„é»ƒé‡‘æ³•å‰‡

1. **å…ˆæœå°‹ï¼Œå†å˜—è©¦** - 70% çš„å•é¡Œå·²æœ‰è§£æ±ºæ–¹æ¡ˆ
2. **è¨˜éŒ„éç¨‹** - å³ä½¿å¤±æ•—çš„å˜—è©¦ä¹Ÿå¾ˆæœ‰åƒ¹å€¼
3. **æ ¹æœ¬åŸå› ** - ä¸åªæ˜¯ä¿®å¾©ç—‡ç‹€ï¼Œè¦æ‰¾åˆ°åŸå› 
4. **å¯é‡ç¾** - è§£æ±ºæ–¹æ¡ˆæ‡‰è©²èƒ½è¢«ä»–äººé‡ç¾
5. **æŒçºŒæ›´æ–°** - æŠ€è¡“æ£§æ›´æ–°æ™‚ï¼ŒåŠæ™‚æ›´æ–°æ–‡æª”

### è¨ºæ–·æŠ€å·§

**ä½¿ç”¨åˆ†å±¤è¨ºæ–·æ³•**ï¼š
```
ç¶²çµ¡å±¤ â†’ é€£æ¥å±¤ â†’ æ‡‰ç”¨å±¤ â†’ æ¥­å‹™å±¤
  â†“         â†“         â†“         â†“
ping/nc   curl    APIæ¸¬è©¦   åŠŸèƒ½æ¸¬è©¦
```

**æ”¶é›†å®Œæ•´ä¿¡æ¯**ï¼š
- éŒ¯èª¤è¨Šæ¯ï¼ˆå®Œæ•´è¤‡è£½ï¼‰
- ç³»çµ±ç’°å¢ƒï¼ˆOS, Nodeç‰ˆæœ¬, ä¾è³´ç‰ˆæœ¬ï¼‰
- é‡ç¾æ­¥é©Ÿï¼ˆè©³ç´°ä¸”å¯é‡è¤‡ï¼‰
- å·²å˜—è©¦æ–¹æ¡ˆï¼ˆæˆåŠŸå’Œå¤±æ•—çš„éƒ½è¨˜éŒ„ï¼‰

---

## ğŸ”— ç›¸é—œè³‡æº

### å®˜æ–¹æ–‡æª”
- [React Native Troubleshooting](https://reactnative.dev/docs/troubleshooting)
- [Expo Debugging](https://docs.expo.dev/debugging/runtime-issues/)
- [Prisma Error Reference](https://www.prisma.io/docs/reference/api-reference/error-reference)
- [NestJS FAQ](https://docs.nestjs.com/faq)
- [Supabase Database Connection](https://supabase.com/docs/guides/database/connecting-to-postgres)

### åœ˜éšŠæ–‡æª”
- [é–‹ç™¼æ–‡ä»¶.md](./é–‹ç™¼æ–‡ä»¶.md) - å®Œæ•´é–‹ç™¼è¨˜éŒ„
- [ä¸»é¡Œç³»çµ±.md](./ä¸»é¡Œç³»çµ±.md) - ä¸»é¡Œç³»çµ±æ–‡æª”
- [API_TESTING.md](../backend/API_TESTING.md) - API æ¸¬è©¦æŒ‡å—

---

## å¾…è£œå……åˆ†é¡

### 8. MongoDB ç‰¹å®šå•é¡Œ
- é ç•™ä½ç½®

### 9. éƒ¨ç½²ç›¸é—œå•é¡Œ
- é ç•™ä½ç½®

### 10. æ€§èƒ½å„ªåŒ–å•é¡Œ
- é ç•™ä½ç½®

### 11. å®‰å…¨æ€§å•é¡Œ
- é ç•™ä½ç½®

---

**æ–‡æª”ç¶­è­·è€…**: é–‹ç™¼åœ˜éšŠå…¨é«”æˆå“¡  
**æœ€å¾Œæ›´æ–°**: 2025-11-02  
**ç‰ˆæœ¬**: 2.0

---

**ä½¿ç”¨æç¤º**ï¼š
1. ğŸ“– é‡åˆ°å•é¡Œå…ˆç”¨ Ctrl+F æœå°‹é—œéµå­—
2. ğŸ” æŒ‰ç…§è¨ºæ–·æ­¥é©Ÿé€æ­¥æ’æŸ¥
3. âœï¸ è§£æ±ºå¾Œè¨˜å¾—æ›´æ–°æ–‡æª”ï¼ˆä½¿ç”¨æ¨¡æ¿ï¼‰
4. ğŸ“Š åœ¨è¿½è¹¤çœ‹æ¿æ·»åŠ å•é¡Œè¨˜éŒ„
5. ğŸ”„ å®šæœŸå›é¡§å’Œå„ªåŒ–è§£æ±ºæ–¹æ¡ˆ

---

**è¨˜ä½**ï¼šæ¯å€‹è§£æ±ºçš„å•é¡Œéƒ½æ˜¯åœ˜éšŠå¯¶è²´çš„çŸ¥è­˜è³‡ç”¢ï¼ğŸ’
