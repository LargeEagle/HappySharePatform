# æ–‡ä»¶åç¨±æœå°‹åŠŸèƒ½ - ç°¡åŒ–æ–¹æ¡ˆ

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 æ ¸å¿ƒéœ€æ±‚
- ğŸ“„ æœå°‹æ–‡ç« ä¸­ä¸Šå‚³çš„æ–‡ä»¶ï¼ˆæŒ‰æ–‡ä»¶åï¼‰
- ğŸ” æ”¯æŒæ¨¡ç³Šæœå°‹ï¼ˆä¸éœ€è¦å®Œæ•´æ–‡ä»¶åï¼‰
- ğŸ¯ ç°¡å–®ã€å¿«é€Ÿã€æ˜“å¯¦ç¾

### 1.2 ä½¿ç”¨å ´æ™¯
- ç”¨æˆ¶è¨˜å¾—æ–‡ä»¶åçš„ä¸€éƒ¨åˆ†ï¼Œæƒ³æ‰¾åˆ°ç›¸é—œæ–‡ç« 
- æœå°‹ã€Œå ±å‘Šã€èƒ½æ‰¾åˆ°ã€Œ2024å¹´åº¦å ±å‘Š.pdfã€
- æœå°‹ã€Œåœ–ç‰‡ã€èƒ½æ‰¾åˆ°ã€Œæ—…éŠåœ–ç‰‡åˆé›†.zipã€

---

## 2. ç°¡åŒ–çš„æ•¸æ“šæ¨¡å‹è¨­è¨ˆ

### 2.1 æœ€å°åŒ–æ–¹æ¡ˆï¼ˆæ¨è–¦ï¼‰â­â­â­â­â­

ç”±æ–¼åªéœ€æœå°‹æ–‡ä»¶åï¼Œæˆ‘å€‘å¯ä»¥ç”¨æœ€ç°¡å–®çš„æ–¹å¼ï¼š

```prisma
// åª’é«”é™„ä»¶æ¨¡å‹
model Attachment {
  id           String   @id @default(uuid())
  filename     String   // æ–‡ä»¶åï¼ˆå¯æœå°‹ï¼‰
  originalName String   // åŸå§‹æ–‡ä»¶åï¼ˆç”¨æˆ¶ä¸Šå‚³æ™‚çš„åç¨±ï¼‰
  url          String   // æ–‡ä»¶ URL
  mimeType     String   // æ–‡ä»¶é¡å‹ï¼ˆimage/jpeg, application/pdfï¼‰
  size         Int      // æ–‡ä»¶å¤§å°ï¼ˆbytesï¼‰
  
  postId       String
  uploaderId   String
  createdAt    DateTime @default(now())
  
  // é—œè¯
  post         Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  uploader     User     @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  
  @@index([filename])      // æ–‡ä»¶åæœå°‹ç´¢å¼•
  @@index([originalName])  // åŸå§‹æ–‡ä»¶åæœå°‹ç´¢å¼•
  @@index([postId])
  @@map("attachments")
}

// æ›´æ–° Post æ¨¡å‹
model Post {
  // ... ç¾æœ‰æ¬„ä½ ...
  
  attachments  Attachment[]  // ä¸€ç¯‡æ–‡ç« å¯ä»¥æœ‰å¤šå€‹é™„ä»¶
  
  @@map("posts")
}

// æ›´æ–° User æ¨¡å‹
model User {
  // ... ç¾æœ‰æ¬„ä½ ...
  
  attachments  Attachment[]  // ç”¨æˆ¶ä¸Šå‚³çš„é™„ä»¶
  
  @@map("users")
}
```

**å„ªé»ï¼š**
- âœ… æ¥µå…¶ç°¡å–®ï¼Œåªé—œæ³¨æ–‡ä»¶åæœå°‹
- âœ… é–‹ç™¼å¿«é€Ÿï¼ˆ1-2 å¤©å®Œæˆï¼‰
- âœ… æŸ¥è©¢æ€§èƒ½å¥½
- âœ… ç¶­è­·å®¹æ˜“

---

## 3. æ¨¡ç³Šæœå°‹å¯¦ç¾æ–¹æ¡ˆ

### 3.1 æ–¹æ¡ˆ Aï¼šPostgreSQL ILIKEï¼ˆæ¨è–¦ï¼‰â­â­â­â­â­

**ç‰¹é»ï¼š**
- æœ€ç°¡å–®çš„æ¨¡ç³Šæœå°‹
- æ”¯æŒéƒ¨åˆ†åŒ¹é…
- å¤§å°å¯«ä¸æ•æ„Ÿ

**å¯¦ç¾ï¼š**
```typescript
// backend/src/search/search.service.ts

async searchAttachments(params: {
  query: string;
  page: number;
  limit: number;
}) {
  const { query, page, limit } = params;
  const skip = (page - 1) * limit;

  // æ¨¡ç³Šæœå°‹æ–‡ä»¶å
  const where = {
    OR: [
      { filename: { contains: query, mode: 'insensitive' } },
      { originalName: { contains: query, mode: 'insensitive' } },
    ],
  };

  const [attachments, total] = await Promise.all([
    this.prisma.attachment.findMany({
      where,
      include: {
        post: {
          select: { id: true, title: true },
        },
        uploader: {
          select: { id: true, username: true, name: true },
        },
      },
      orderBy: { createdAt: 'desc' },
      skip,
      take: limit,
    }),
    this.prisma.attachment.count({ where }),
  ]);

  return {
    success: true,
    message: 'Attachments found',
    data: {
      attachments,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit),
      },
    },
  };
}
```

**æœå°‹æ•ˆæœç¤ºä¾‹ï¼š**
```
æœå°‹ã€Œå ±å‘Šã€å¯ä»¥æ‰¾åˆ°ï¼š
- "2024å¹´åº¦å ±å‘Š.pdf"
- "è²¡å‹™å ±å‘Š_Q1.xlsx"
- "é …ç›®å ±å‘Šæ›¸.docx"

æœå°‹ã€Œ2024ã€å¯ä»¥æ‰¾åˆ°ï¼š
- "2024å¹´åº¦å ±å‘Š.pdf"
- "2024_ç…§ç‰‡.zip"
- "æœƒè­°è¨˜éŒ„_2024.doc"

æœå°‹ã€Œ.pdfã€å¯ä»¥æ‰¾åˆ°æ‰€æœ‰ PDF æ–‡ä»¶
```

---

### 3.2 æ–¹æ¡ˆ Bï¼šæ¨¡ç³ŠåŒ¹é… + ç›¸ä¼¼åº¦æ’åºï¼ˆé€²éšï¼‰â­â­â­â­

å¦‚æœéœ€è¦æ›´æ™ºèƒ½çš„æœå°‹ï¼ˆä¾‹å¦‚å®¹éŒ¯æ‹¼å¯«ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ PostgreSQL çš„æ¨¡ç³ŠåŒ¹é…ï¼š

```typescript
// ä½¿ç”¨ PostgreSQL çš„ç›¸ä¼¼åº¦å‡½æ•¸
async searchAttachmentsFuzzy(query: string) {
  const results = await this.prisma.$queryRaw`
    SELECT 
      id,
      filename,
      original_name,
      url,
      similarity(filename, ${query}) as similarity_score
    FROM attachments
    WHERE 
      filename ILIKE ${'%' + query + '%'}
      OR original_name ILIKE ${'%' + query + '%'}
      OR similarity(filename, ${query}) > 0.3
    ORDER BY similarity_score DESC
    LIMIT 20
  `;
  
  return results;
}
```

**éœ€è¦å®‰è£ PostgreSQL æ“´å±•ï¼š**
```sql
-- å•Ÿç”¨ pg_trgm æ“´å±•ï¼ˆç”¨æ–¼æ¨¡ç³ŠåŒ¹é…ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- å‰µå»º GIN ç´¢å¼•ï¼ˆåŠ é€Ÿæ¨¡ç³Šæœå°‹ï¼‰
CREATE INDEX attachments_filename_trgm_idx ON attachments USING gin(filename gin_trgm_ops);
CREATE INDEX attachments_original_name_trgm_idx ON attachments USING gin(original_name gin_trgm_ops);
```

**æ•ˆæœï¼š**
- æœå°‹ã€Œå ±å¿ã€ï¼ˆéŒ¯å­—ï¼‰ä¹Ÿèƒ½æ‰¾åˆ°ã€Œå ±å‘Šã€
- æœå°‹ã€Œreprotã€ï¼ˆæ‹¼éŒ¯ï¼‰ä¹Ÿèƒ½æ‰¾åˆ°ã€Œreportã€

---

## 4. å®Œæ•´å¯¦ç¾ä»£ç¢¼

### 4.1 å¾Œç«¯å¯¦ç¾

#### 4.1.1 SearchController æ·»åŠ é™„ä»¶æœå°‹

```typescript
// backend/src/search/search.controller.ts

import { Controller, Get, Query } from '@nestjs/common';
import { SearchService } from './search.service';

@Controller('search')
export class SearchController {
  constructor(private readonly searchService: SearchService) {}

  /**
   * æœå°‹é™„ä»¶ï¼ˆæŒ‰æ–‡ä»¶åï¼‰
   */
  @Get('attachments')
  async searchAttachments(
    @Query('q') query: string,
    @Query('page') page?: string,
    @Query('limit') limit?: string,
  ) {
    if (!query) {
      return {
        success: false,
        message: 'Query parameter is required',
      };
    }

    return this.searchService.searchAttachments({
      query,
      page: parseInt(page) || 1,
      limit: parseInt(limit) || 10,
    });
  }

  /**
   * æœå°‹åŒ…å«é™„ä»¶çš„æ–‡ç« 
   */
  @Get('posts/with-attachments')
  async searchPostsWithAttachments(
    @Query('q') query: string,
    @Query('page') page?: string,
    @Query('limit') limit?: string,
  ) {
    if (!query) {
      return {
        success: false,
        message: 'Query parameter is required',
      };
    }

    return this.searchService.searchPostsWithAttachments({
      query,
      page: parseInt(page) || 1,
      limit: parseInt(limit) || 10,
    });
  }
}
```

#### 4.1.2 SearchService å¯¦ç¾

```typescript
// backend/src/search/search.service.ts

import { Injectable } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';

@Injectable()
export class SearchService {
  constructor(private prisma: PrismaService) {}

  /**
   * æœå°‹é™„ä»¶ï¼ˆæŒ‰æ–‡ä»¶åï¼‰
   */
  async searchAttachments(params: {
    query: string;
    page: number;
    limit: number;
  }) {
    const { query, page, limit } = params;
    const skip = (page - 1) * limit;

    // æ¨¡ç³Šæœå°‹æ–‡ä»¶å
    const where = {
      OR: [
        { filename: { contains: query, mode: 'insensitive' as const } },
        { originalName: { contains: query, mode: 'insensitive' as const } },
      ],
    };

    const [attachments, total] = await Promise.all([
      this.prisma.attachment.findMany({
        where,
        include: {
          post: {
            select: {
              id: true,
              title: true,
              createdAt: true,
            },
          },
          uploader: {
            select: {
              id: true,
              username: true,
              name: true,
              avatar: true,
            },
          },
        },
        orderBy: { createdAt: 'desc' },
        skip,
        take: limit,
      }),
      this.prisma.attachment.count({ where }),
    ]);

    return {
      success: true,
      message: `Found ${total} attachment(s)`,
      data: {
        attachments,
        pagination: {
          page,
          limit,
          total,
          totalPages: Math.ceil(total / limit),
          hasMore: page * limit < total,
        },
      },
    };
  }

  /**
   * æœå°‹åŒ…å«ç‰¹å®šé™„ä»¶çš„æ–‡ç« 
   */
  async searchPostsWithAttachments(params: {
    query: string;
    page: number;
    limit: number;
  }) {
    const { query, page, limit } = params;
    const skip = (page - 1) * limit;

    const where = {
      isPublished: true,
      attachments: {
        some: {
          OR: [
            { filename: { contains: query, mode: 'insensitive' as const } },
            { originalName: { contains: query, mode: 'insensitive' as const } },
          ],
        },
      },
    };

    const [posts, total] = await Promise.all([
      this.prisma.post.findMany({
        where,
        include: {
          author: {
            select: {
              id: true,
              username: true,
              name: true,
              avatar: true,
            },
          },
          attachments: {
            where: {
              OR: [
                { filename: { contains: query, mode: 'insensitive' as const } },
                { originalName: { contains: query, mode: 'insensitive' as const } },
              ],
            },
          },
        },
        orderBy: { createdAt: 'desc' },
        skip,
        take: limit,
      }),
      this.prisma.post.count({ where }),
    ]);

    return {
      success: true,
      message: `Found ${total} post(s) with matching attachments`,
      data: {
        posts,
        pagination: {
          page,
          limit,
          total,
          totalPages: Math.ceil(total / limit),
          hasMore: page * limit < total,
        },
      },
    };
  }
}
```

---

### 4.2 å‰ç«¯å¯¦ç¾

#### 4.2.1 æœå°‹æœå‹™

```typescript
// frontend/src/services/search.service.ts

import { apiClient } from './api.client';

export interface Attachment {
  id: string;
  filename: string;
  originalName: string;
  url: string;
  mimeType: string;
  size: number;
  createdAt: string;
  post: {
    id: string;
    title: string;
  };
  uploader: {
    id: string;
    username: string;
    name: string;
  };
}

export const searchService = {
  /**
   * æœå°‹é™„ä»¶ï¼ˆæŒ‰æ–‡ä»¶åï¼‰
   */
  async searchAttachments(params: {
    query: string;
    page?: number;
    limit?: number;
  }) {
    const response = await apiClient.get('/search/attachments', { params });
    return {
      attachments: response.data.attachments as Attachment[],
      pagination: response.data.pagination,
    };
  },

  /**
   * æœå°‹åŒ…å«é™„ä»¶çš„æ–‡ç« 
   */
  async searchPostsWithAttachments(params: {
    query: string;
    page?: number;
    limit?: number;
  }) {
    const response = await apiClient.get('/search/posts/with-attachments', { params });
    return {
      posts: response.data.posts,
      pagination: response.data.pagination,
    };
  },
};
```

#### 4.2.2 æœå°‹é é¢ UI

```typescript
// frontend/src/screens/SearchScreen.tsx

import React, { useState } from 'react';
import { View, FlatList, StyleSheet } from 'react-native';
import { Searchbar, Card, Text, Chip, Avatar, IconButton } from 'react-native-paper';
import { searchService, Attachment } from '../services/search.service';

export default function SearchScreen() {
  const [query, setQuery] = useState('');
  const [searchType, setSearchType] = useState<'attachments' | 'posts'>('attachments');
  const [results, setResults] = useState<Attachment[]>([]);
  const [loading, setLoading] = useState(false);

  const handleSearch = async () => {
    if (!query.trim()) return;
    
    setLoading(true);
    try {
      if (searchType === 'attachments') {
        const data = await searchService.searchAttachments({ query });
        setResults(data.attachments);
      } else {
        const data = await searchService.searchPostsWithAttachments({ query });
        setResults(data.posts);
      }
    } catch (error) {
      console.error('Search error:', error);
    } finally {
      setLoading(false);
    }
  };

  const formatFileSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  const getFileIcon = (mimeType: string) => {
    if (mimeType.startsWith('image/')) return 'image';
    if (mimeType.startsWith('video/')) return 'video';
    if (mimeType.includes('pdf')) return 'file-pdf';
    if (mimeType.includes('word')) return 'file-word';
    if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'file-excel';
    return 'file';
  };

  const renderAttachment = ({ item }: { item: Attachment }) => (
    <Card style={styles.card}>
      <Card.Content>
        <View style={styles.row}>
          <Avatar.Icon 
            size={48} 
            icon={getFileIcon(item.mimeType)} 
            style={styles.icon}
          />
          <View style={styles.info}>
            <Text variant="titleMedium" numberOfLines={1}>
              {item.originalName}
            </Text>
            <Text variant="bodySmall" style={styles.subtitle}>
              {formatFileSize(item.size)} â€¢ {item.post.title}
            </Text>
            <View style={styles.meta}>
              <Chip icon="account" compact>
                {item.uploader.name || item.uploader.username}
              </Chip>
            </View>
          </View>
          <IconButton
            icon="download"
            onPress={() => {
              // ä¸‹è¼‰æˆ–æ‰“é–‹æ–‡ä»¶
              console.log('Download:', item.url);
            }}
          />
        </View>
      </Card.Content>
    </Card>
  );

  return (
    <View style={styles.container}>
      <Searchbar
        placeholder="æœå°‹æ–‡ä»¶åç¨±..."
        value={query}
        onChangeText={setQuery}
        onSubmitEditing={handleSearch}
        icon="file-search"
      />

      <View style={styles.filters}>
        <Chip
          selected={searchType === 'attachments'}
          onPress={() => setSearchType('attachments')}
          style={styles.chip}
        >
          æœå°‹æ–‡ä»¶
        </Chip>
        <Chip
          selected={searchType === 'posts'}
          onPress={() => setSearchType('posts')}
          style={styles.chip}
        >
          æœå°‹æ–‡ç« 
        </Chip>
      </View>

      <FlatList
        data={results}
        renderItem={renderAttachment}
        keyExtractor={(item) => item.id}
        refreshing={loading}
        onRefresh={handleSearch}
        ListEmptyComponent={
          <View style={styles.empty}>
            <Text>
              {query ? 'æ²’æœ‰æ‰¾åˆ°ç›¸é—œæ–‡ä»¶' : 'è¼¸å…¥æ–‡ä»¶åç¨±é–‹å§‹æœå°‹'}
            </Text>
          </View>
        }
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
  },
  filters: {
    flexDirection: 'row',
    marginVertical: 12,
    gap: 8,
  },
  chip: {
    marginRight: 8,
  },
  card: {
    marginBottom: 12,
  },
  row: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  icon: {
    marginRight: 12,
  },
  info: {
    flex: 1,
  },
  subtitle: {
    opacity: 0.7,
    marginTop: 4,
  },
  meta: {
    flexDirection: 'row',
    marginTop: 8,
  },
  empty: {
    padding: 32,
    alignItems: 'center',
  },
});
```

---

## 5. æ•¸æ“šåº«é·ç§»

### 5.1 å‰µå»º Attachment è¡¨

```bash
# å‰µå»ºæ–°çš„é·ç§»
npx prisma migrate dev --name add_attachments
```

### 5.2 é·ç§»è…³æœ¬ï¼ˆå¦‚æœéœ€è¦é·ç§»ç¾æœ‰åœ–ç‰‡ï¼‰

```typescript
// prisma/migrate-images-to-attachments.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function migrateImagesToAttachments() {
  console.log('Starting migration...');

  // ç²å–æ‰€æœ‰æœ‰åœ–ç‰‡çš„æ–‡ç« 
  const postsWithImages = await prisma.post.findMany({
    where: {
      image: { not: null },
    },
  });

  console.log(`Found ${postsWithImages.length} posts with images`);

  for (const post of postsWithImages) {
    // å¾ URL æå–æ–‡ä»¶å
    const filename = post.image!.split('/').pop() || 'image.jpg';
    
    // å‰µå»ºé™„ä»¶è¨˜éŒ„
    await prisma.attachment.create({
      data: {
        filename,
        originalName: filename,
        url: post.image!,
        mimeType: 'image/jpeg', // å‡è¨­æ˜¯ JPEG
        size: 0, // æœªçŸ¥å¤§å°
        postId: post.id,
        uploaderId: post.authorId,
      },
    });

    console.log(`Migrated image for post: ${post.id}`);
  }

  console.log('Migration completed!');
}

migrateImagesToAttachments()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

---

## 6. å¯¦æ–½è¨ˆåŠƒ

### 6.1 é–‹ç™¼æ­¥é©Ÿ

**éšæ®µ 1ï¼šæ•¸æ“šæ¨¡å‹ï¼ˆ0.5 å¤©ï¼‰**
- [ ] æ·»åŠ  Attachment æ¨¡å‹åˆ° Prisma schema
- [ ] åŸ·è¡Œæ•¸æ“šåº«é·ç§»
- [ ] æ·»åŠ ç´¢å¼•

**éšæ®µ 2ï¼šå¾Œç«¯ APIï¼ˆ1 å¤©ï¼‰**
- [ ] å¯¦ç¾é™„ä»¶æœå°‹ API
- [ ] å¯¦ç¾æ–‡ç« é™„ä»¶æœå°‹ API
- [ ] æ·»åŠ  API æ¸¬è©¦

**éšæ®µ 3ï¼šå‰ç«¯å¯¦ç¾ï¼ˆ1 å¤©ï¼‰**
- [ ] å‰µå»ºæœå°‹æœå‹™
- [ ] å¯¦ç¾æœå°‹é é¢ UI
- [ ] æ·»åŠ æ–‡ä»¶é è¦½åŠŸèƒ½

**éšæ®µ 4ï¼šæ¸¬è©¦å’Œå„ªåŒ–ï¼ˆ0.5 å¤©ï¼‰**
- [ ] æ¸¬è©¦æ¨¡ç³Šæœå°‹æ•ˆæœ
- [ ] æ€§èƒ½æ¸¬è©¦
- [ ] ç”¨æˆ¶é«”é©—å„ªåŒ–

**ç¸½æ™‚é–“ï¼š3 å¤©** âœ…

---

## 7. API æ¸¬è©¦ç¤ºä¾‹

### 7.1 æ¸¬è©¦é…ç½®

```typescript
// testing-tools/src/tests/search-attachments.test.ts

export const searchAttachmentsTests = [
  {
    name: 'Search attachments - exact match',
    endpoint: '/search/attachments',
    method: 'GET',
    params: {
      q: 'å ±å‘Š.pdf',
      page: 1,
      limit: 10,
    },
    expectedStatus: 200,
  },
  {
    name: 'Search attachments - partial match',
    endpoint: '/search/attachments',
    method: 'GET',
    params: {
      q: 'å ±å‘Š',
      page: 1,
      limit: 10,
    },
    expectedStatus: 200,
  },
  {
    name: 'Search posts with attachments',
    endpoint: '/search/posts/with-attachments',
    method: 'GET',
    params: {
      q: '2024',
      page: 1,
      limit: 10,
    },
    expectedStatus: 200,
  },
];
```

### 7.2 ä½¿ç”¨ curl æ¸¬è©¦

```bash
# æœå°‹é™„ä»¶
curl "http://localhost:5000/api/search/attachments?q=å ±å‘Š"

# æœå°‹åŒ…å«é™„ä»¶çš„æ–‡ç« 
curl "http://localhost:5000/api/search/posts/with-attachments?q=2024"

# åˆ†é æœå°‹
curl "http://localhost:5000/api/search/attachments?q=pdf&page=2&limit=5"
```

---

## 8. æ€§èƒ½å„ªåŒ–

### 8.1 æ•¸æ“šåº«ç´¢å¼•

```sql
-- åŸºç¤ç´¢å¼•ï¼ˆè‡ªå‹•å‰µå»ºï¼‰
CREATE INDEX idx_attachments_filename ON attachments(filename);
CREATE INDEX idx_attachments_original_name ON attachments(original_name);
CREATE INDEX idx_attachments_post_id ON attachments(post_id);

-- å¦‚æœéœ€è¦æ›´å¿«çš„æ¨¡ç³Šæœå°‹ï¼ˆå¯é¸ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX idx_attachments_filename_trgm ON attachments USING gin(filename gin_trgm_ops);
```

### 8.2 æŸ¥è©¢å„ªåŒ–å»ºè­°

```typescript
// åªè¿”å›éœ€è¦çš„æ¬„ä½
const attachments = await prisma.attachment.findMany({
  where,
  select: {
    id: true,
    filename: true,
    originalName: true,
    url: true,
    size: true,
    post: {
      select: { id: true, title: true },  // åªé¸æ“‡éœ€è¦çš„æ¬„ä½
    },
  },
});
```

---

## 9. æœå°‹å»ºè­°å„ªåŒ–ï¼ˆå¯é¸ï¼‰

### 9.1 æœå°‹æ­·å²

```typescript
// ä¿å­˜æœå°‹æ­·å²ï¼ˆå‰ç«¯ LocalStorageï¼‰
const searchHistory = {
  save: (query: string) => {
    const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    if (!history.includes(query)) {
      history.unshift(query);
      localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 10)));
    }
  },
  
  get: () => {
    return JSON.parse(localStorage.getItem('searchHistory') || '[]');
  },
};
```

### 9.2 è‡ªå‹•å®Œæˆå»ºè­°

```typescript
// æ ¹æ“šç”¨æˆ¶è¼¸å…¥æä¾›å»ºè­°
async getSearchSuggestions(query: string) {
  if (query.length < 2) return [];
  
  const suggestions = await prisma.attachment.findMany({
    where: {
      originalName: { contains: query, mode: 'insensitive' },
    },
    select: { originalName: true },
    distinct: ['originalName'],
    take: 5,
  });
  
  return suggestions.map(s => s.originalName);
}
```

---

## 10. ç¸½çµ

### 10.1 å„ªé»

âœ… **æ¥µå…¶ç°¡å–®**
- åªéœ€è¦ä¸€å€‹ Attachment è¡¨
- ä½¿ç”¨åŸºç¤çš„ ILIKE æ¨¡ç³Šæœå°‹
- ç„¡éœ€è¤‡é›œçš„åˆ†è©æˆ–å…¨æ–‡æœå°‹

âœ… **é–‹ç™¼å¿«é€Ÿ**
- ç¸½é–‹ç™¼æ™‚é–“ï¼š3 å¤©
- ç«‹å³å¯ç”¨ï¼Œç„¡éœ€ç­‰å¾…

âœ… **æ€§èƒ½è‰¯å¥½**
- æœ‰ç´¢å¼•æ”¯æŒ
- æŸ¥è©¢é€Ÿåº¦å¿«
- é©åˆä¸­å°å‹æ•¸æ“šé‡

âœ… **ç¶­è­·å®¹æ˜“**
- ä»£ç¢¼ç°¡å–®ç›´è§€
- ç„¡éœ€é¡å¤–æœå‹™
- æ˜“æ–¼èª¿è©¦

### 10.2 é™åˆ¶

âš ï¸ **åŠŸèƒ½ç°¡å–®**
- åªèƒ½æœå°‹æ–‡ä»¶å
- ä¸æ”¯æŒå…§å®¹æœå°‹
- æ²’æœ‰æ™ºèƒ½æ’åº

âš ï¸ **é©ç”¨ç¯„åœ**
- é©åˆæ–‡ä»¶æ•¸é‡ < 10è¬
- é©åˆç°¡å–®å ´æ™¯

### 10.3 å»ºè­°

**é©åˆç«‹å³å¯¦æ–½ï¼š**
- âœ… éœ€æ±‚ç°¡å–®æ˜ç¢ºï¼ˆåªæœå°‹æ–‡ä»¶åï¼‰
- âœ… é–‹ç™¼æ™‚é–“çŸ­ï¼ˆ3 å¤©ï¼‰
- âœ… ç„¡éœ€é¡å¤–æˆæœ¬
- âœ… å¯ä»¥å¿«é€Ÿä¸Šç·šé©—è­‰éœ€æ±‚

**å¯¦æ–½é †åºå»ºè­°ï¼š**
1. å…ˆå¯¦ç¾åŸºç¤æ–‡å­—æœå°‹ï¼ˆæ–‡ç« ã€ç”¨æˆ¶ï¼‰â† å„ªå…ˆ
2. å†å¯¦ç¾æ–‡ä»¶åæœå°‹ â† æ¬¡è¦
3. æ ¹æ“šéœ€æ±‚æ±ºå®šæ˜¯å¦éœ€è¦æ›´è¤‡é›œçš„å¤šåª’é«”åŠŸèƒ½

---

**æ–‡æª”ç‰ˆæœ¬ï¼š** v1.0  
**å‰µå»ºæ—¥æœŸï¼š** 2025-10-29  
**ä½œè€…ï¼š** HAPPY SHARE é–‹ç™¼åœ˜éšŠ  
**ç‹€æ…‹ï¼š** âœ… æ¨è–¦å¯¦æ–½ - ç°¡å–®å¯¦ç”¨
**é è¨ˆæ™‚é–“ï¼š** 3 å¤©
