<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試用戶 API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            margin-top: 0;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
            background: #d4edda;
        }
        .error {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }
        .info {
            padding: 15px;
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            border-radius: 6px;
            margin: 15px 0;
        }
        .url-display {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            border-left: 4px solid #ffc107;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok {
            background: #28a745;
            color: white;
        }
        .status-error {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 用戶 API 路徑測試工具</h1>
        
        <div class="info">
            <strong>🎯 測試目標：</strong>驗證 API 路徑是否正確，確保沒有重複的 <code>/api/</code> 前綴
            <br><br>
            <strong>✅ 正確格式：</strong> <code>http://localhost:5000/api/users/...</code>
            <br>
            <strong>❌ 錯誤格式：</strong> <code>http://localhost:5000/api/api/users/...</code>
        </div>

        <div class="test-section">
            <h3>測試 1: 獲取用戶資料</h3>
            <button onclick="testGetUserProfile()">測試 GET /api/users/:id</button>
            <div id="result1" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>測試 2: 獲取用戶文章</h3>
            <button onclick="testGetUserPosts()">測試 GET /api/users/:id/posts</button>
            <div id="result2" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>測試 3: 使用登入 Token 獲取用戶資料</h3>
            <button onclick="testLoginAndGetProfile()">先登入再獲取資料</button>
            <div id="result3" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>測試 4: 直接檢查 URL 格式</h3>
            <button onclick="checkUrlFormat()">檢查 URL 配置</button>
            <div id="result4" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const baseUrl = 'http://localhost:5000/api';
        const testUserId = '0c65432d-4320-4784-8b59-92e05c21b34e'; // Alice

        function showResult(elementId, content, isSuccess) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = isSuccess ? 'result success' : 'result error';
            element.textContent = content;
        }

        async function testGetUserProfile() {
            const resultDiv = document.getElementById('result1');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '🔄 正在測試...';

            try {
                const url = `${baseUrl}/users/${testUserId}`;
                
                resultDiv.innerHTML = `<div class="url-display">📡 請求 URL: ${url}</div>正在發送請求...`;

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    // 檢查 URL 格式
                    const hasDoubleApi = url.includes('/api/api/');
                    const urlStatus = hasDoubleApi 
                        ? '<span class="status-badge status-error">URL 錯誤</span>' 
                        : '<span class="status-badge status-ok">URL 正確</span>';

                    showResult('result1', 
                        `✅ 測試成功！${urlStatus}\n\n` +
                        `請求 URL: ${url}\n` +
                        `HTTP 狀態: ${response.status} ${response.statusText}\n\n` +
                        `返回數據:\n${JSON.stringify(data, null, 2)}`,
                        true
                    );
                } else {
                    showResult('result1',
                        `❌ 測試失敗！\n\n` +
                        `請求 URL: ${url}\n` +
                        `HTTP 狀態: ${response.status} ${response.statusText}\n\n` +
                        `錯誤信息:\n${JSON.stringify(data, null, 2)}`,
                        false
                    );
                }
            } catch (error) {
                showResult('result1',
                    `❌ 請求發生錯誤！\n\n` +
                    `錯誤: ${error.message}\n\n` +
                    `請確保:\n` +
                    `1. 後端服務正在運行 (http://localhost:5000)\n` +
                    `2. CORS 設置正確\n` +
                    `3. 網絡連接正常`,
                    false
                );
            }
        }

        async function testGetUserPosts() {
            const resultDiv = document.getElementById('result2');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '🔄 正在測試...';

            try {
                const url = `${baseUrl}/users/${testUserId}/posts?page=1&limit=10`;
                
                resultDiv.innerHTML = `<div class="url-display">📡 請求 URL: ${url}</div>正在發送請求...`;

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    const hasDoubleApi = url.includes('/api/api/');
                    const urlStatus = hasDoubleApi 
                        ? '<span class="status-badge status-error">URL 錯誤</span>' 
                        : '<span class="status-badge status-ok">URL 正確</span>';

                    showResult('result2',
                        `✅ 測試成功！${urlStatus}\n\n` +
                        `請求 URL: ${url}\n` +
                        `HTTP 狀態: ${response.status} ${response.statusText}\n\n` +
                        `返回數據:\n${JSON.stringify(data, null, 2)}`,
                        true
                    );
                } else {
                    showResult('result2',
                        `❌ 測試失敗！\n\n` +
                        `請求 URL: ${url}\n` +
                        `HTTP 狀態: ${response.status} ${response.statusText}\n\n` +
                        `錯誤信息:\n${JSON.stringify(data, null, 2)}`,
                        false
                    );
                }
            } catch (error) {
                showResult('result2',
                    `❌ 請求發生錯誤！\n\n` +
                    `錯誤: ${error.message}`,
                    false
                );
            }
        }

        async function testLoginAndGetProfile() {
            const resultDiv = document.getElementById('result3');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '🔄 正在測試...';

            try {
                // 步驟 1: 登入
                const loginUrl = `${baseUrl}/auth/login`;
                resultDiv.textContent = `步驟 1: 正在登入...\nURL: ${loginUrl}`;

                const loginResponse = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'alice@happyshare.com',
                        password: 'Test@1234'
                    })
                });

                const loginData = await loginResponse.json();

                if (!loginResponse.ok) {
                    showResult('result3',
                        `❌ 登入失敗！\n\n` +
                        `URL: ${loginUrl}\n` +
                        `HTTP 狀態: ${loginResponse.status}\n\n` +
                        `錯誤信息:\n${JSON.stringify(loginData, null, 2)}`,
                        false
                    );
                    return;
                }

                const token = loginData.data.token;
                const userId = loginData.data.user.id;

                // 步驟 2: 使用 token 獲取用戶資料
                const profileUrl = `${baseUrl}/users/${userId}`;
                resultDiv.textContent = `步驟 1: ✅ 登入成功\n步驟 2: 正在獲取用戶資料...\nURL: ${profileUrl}`;

                const profileResponse = await fetch(profileUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const profileData = await profileResponse.json();

                if (profileResponse.ok) {
                    const hasDoubleApi = profileUrl.includes('/api/api/');
                    const urlStatus = hasDoubleApi 
                        ? '<span class="status-badge status-error">URL 錯誤</span>' 
                        : '<span class="status-badge status-ok">URL 正確</span>';

                    showResult('result3',
                        `✅ 完整測試成功！${urlStatus}\n\n` +
                        `步驟 1: 登入成功\n` +
                        `  - URL: ${loginUrl}\n` +
                        `  - Token: ${token.substring(0, 20)}...\n\n` +
                        `步驟 2: 獲取用戶資料成功\n` +
                        `  - URL: ${profileUrl}\n` +
                        `  - HTTP 狀態: ${profileResponse.status}\n\n` +
                        `用戶資料:\n${JSON.stringify(profileData.data, null, 2)}`,
                        true
                    );
                } else {
                    showResult('result3',
                        `❌ 獲取用戶資料失敗！\n\n` +
                        `URL: ${profileUrl}\n` +
                        `HTTP 狀態: ${profileResponse.status}\n\n` +
                        `錯誤信息:\n${JSON.stringify(profileData, null, 2)}`,
                        false
                    );
                }
            } catch (error) {
                showResult('result3',
                    `❌ 測試過程發生錯誤！\n\n` +
                    `錯誤: ${error.message}`,
                    false
                );
            }
        }

        function checkUrlFormat() {
            const resultDiv = document.getElementById('result4');
            resultDiv.style.display = 'block';
            
            const testUrls = [
                { path: '/users/:id', full: `${baseUrl}/users/${testUserId}` },
                { path: '/users/:id/posts', full: `${baseUrl}/users/${testUserId}/posts` },
                { path: '/auth/login', full: `${baseUrl}/auth/login` },
                { path: '/auth/me', full: `${baseUrl}/auth/me` },
            ];

            let report = '🔍 URL 格式檢查報告\n\n';
            report += `Base URL: ${baseUrl}\n\n`;
            
            let allCorrect = true;

            testUrls.forEach(({ path, full }) => {
                const hasDoubleApi = full.includes('/api/api/');
                const status = hasDoubleApi ? '❌ 錯誤' : '✅ 正確';
                
                if (hasDoubleApi) allCorrect = false;

                report += `${status} ${path}\n`;
                report += `   完整 URL: ${full}\n`;
                
                if (hasDoubleApi) {
                    report += `   ⚠️  警告: URL 包含重複的 /api/ 前綴！\n`;
                }
                report += '\n';
            });

            report += '\n📋 診斷結果:\n';
            if (allCorrect) {
                report += '✅ 所有 URL 格式正確！\n';
                report += '\n配置說明:\n';
                report += '- baseUrl 包含 /api\n';
                report += '- service 方法路徑不包含 /api/ 前綴\n';
                report += '- 組合後的 URL 格式正確';
                resultDiv.className = 'result success';
            } else {
                report += '❌ 發現 URL 格式錯誤！\n';
                report += '\n可能原因:\n';
                report += '1. service 方法中路徑包含了 /api/ 前綴\n';
                report += '2. baseUrl 配置不正確\n';
                report += '\n解決方案:\n';
                report += '1. 檢查 user.api.ts 中的路徑配置\n';
                report += '2. 確保路徑格式為 /users/... 而不是 /api/users/...\n';
                report += '3. 清除瀏覽器緩存並重新載入';
                resultDiv.className = 'result error';
            }

            resultDiv.textContent = report;
        }

        // 頁面載入時自動檢查 URL 格式
        window.onload = () => {
            checkUrlFormat();
        };
    </script>
</body>
</html>
